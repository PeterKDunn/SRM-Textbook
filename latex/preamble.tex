%%%%% START PREAMBLE %%%%%
%%%%%

% Explicitly need for CRC, according to `Run_This_Example.tex`:
\usepackage{fixltx2e,fix-cm}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{graphicx}
\usepackage{makeidx} % For making index
\usepackage{multicol} % For occasional two-column parts
\usepackage{multirow} % For occasional tables with rows combined in cols
\usepackage{imakeidx} % Add some pre-index text


\usepackage{customdice} % Help with die unicode!
\usepackage{pifont} % Checkmark \ding{51}
% Added by me:
\usepackage{booktabs} % Nicer tables
%\usepackage{tabto-ltx} % Allows tabbing for some alignments
%\usepackage{longtable} % Long table: Probably not needed
%\usepackage[bf,singlelinecheck=off]{caption} % Format captions
%\usepackage{siunitx} % Correct units formatting
\usepackage{microtype} % Better spacing and easier reading
\usepackage{tabularx} % For column specifications, using the kable_styling function  column_spec()
\usepackage{tabu} % For column specifications, using the kable_styling function  column_spec()
\usepackage{float} % Needed for some kableExtra stuff
\usepackage{mdframed}  % Needed for some environment definitions (callouts)
\usepackage{enumitem} % To change the itemize spacing in exercises.
%\usepackage{subfig} % For sub-figure captions
\usepackage{caption}
\usepackage{wrapfig} % For text-wrapping figures


\usepackage[x11names]{xcolor}


% Increase space between ToC number and title 
%\usepackage[subfigure]{tocloft}
%\usepackage{subfigure} % Loaded by package  locloft... but seems needed here or I get an error
%\setlength\cftsecnumwidth{3em}
% Redefining the ToC with custom lengths
%%% Correct spacing for Table of Contents numbering
% Define a new command to add chapters to the ToC
\usepackage{tocloft}


% For sometimes stacking things on top of each other (used in table, in the selecting a test chapter)
\usepackage{stackengine} 
\renewcommand\stacktype{L}
\def\stackalignment{l}


% For some fancy table things on occasion:
\usepackage{array}
\usepackage{ragged2e}
\newcolumntype{P}[1]{>{\RaggedLeft\hspace{0pt}}p{#1}} % This allows right-aligned, fixed with cols


% FIGURE PLACEMENT: https://tex.stackexchange.com/questions/140568/how-to-set-default-positioning-of-figure-table-document-wide
\makeatletter
  \providecommand*\setfloatlocations[2]{\@namedef{fps@#1}{#2}}
\makeatother
\setfloatlocations{figure}{hbtp}
\setfloatlocations{table}{hbtp}


\usepackage{framed,color}
\definecolor{shadecolor}{RGB}{245,245,245}
\definecolor{lightshadecolor}{RGB}{230, 230, 255}
\definecolor{textcolor}{RGB}{100,100,100}

%\definecolor{exampleExtraColor}{RGB}{209, 223, 250}
%\definecolor{examplecolor}{RGB}{245, 245, 245}

% \renewcommand{\textfraction}{0.05}
% \renewcommand{\topfraction}{0.8}
% \renewcommand{\bottomfraction}{0.8}
% \renewcommand{\floatpagefraction}{0.75}

%\renewenvironment{quote}{\begin{VF}}{\end{VF}}
\renewenvironment{quote}%
  {\begin{kframe}}
  {\end{kframe}}
  

% Default figure width
\setkeys{Gin}{width=0.5\linewidth}


% % kframe
% \makeatletter
% \newenvironment{kframe}{%
% \smallskip{}
% \setlength{\fboxsep}{0.8em} % Space all around the text, between text and shaded box
%  \def\at@end@of@kframe{}%
%  \ifinner\ifhmode%
%   \def\at@end@of@kframe{\end{minipage}}%
%   \begin{minipage}{\textwidth}
%  \fi\fi%
%  \def\FrameCommand##1{%\hskip\@totalleftmargin\hskip 3mm\hskip-\fboxsep % The hspace moves shading in from left edge
%  \hspace{6mm} % Move the text in the shaded box to the left by 3mm
% % \colorbox{shadecolor}{##1}\hskip-\fboxsep
% %     % There is no \\@totalrightmargin, so:
% %     \hskip 3mm%
% %     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}% The hspace moves the shading in; \columnwidth move the whole box in
%    \colorbox{shadecolor}{%
%       \hspace{3mm}% Add padding inside the shaded box
%       \begin{minipage}{\dimexpr\textwidth-6mm} % Adjust width of text inside shaded box
%         ##1
%       \end{minipage}%
%       \hspace{3mm}% Add padding inside the shaded box
%     }%
%   }%
%  \MakeFramed {\setlength{\hsize}{\textwidth}%\advance\hsize-\textwidth
%    %\@totalleftmargin\z@ \linewidth\hsize % The left-side indent
%    \@setminipage}}%
%  {\par\unskip\endMakeFramed%
%  \at@end@of@kframe}
%  \makeatother


\makeatletter
\newenvironment{kframe}{%
  \smallskip{}
  \setlength{\fboxsep}{0.8em} % Space between text and shaded box
  \def\at@end@of@kframe{}%
  \ifinner\ifhmode%
    \def\at@end@of@kframe{\end{minipage}}%
    \begin{minipage}{\textwidth-\fboxsep} % Ensure the minipage width matches the text width
  \fi\fi%
  \def\FrameCommand##1{%
    \hspace{3mm}% Indentation from the left edge of the shaded box
    \colorbox{shadecolor}{%
      \hspace{0mm}% Shift the text inside the shaded box 3mm to the left
      \begin{minipage}{\dimexpr\linewidth-8mm}% Adjust the width of the text inside the shaded box
        ##1
      \end{minipage}%
    }%
    \hspace{3mm}% Indentation from the right edge of the shaded box
  }%
  \MakeFramed {\setlength{\hsize}{\textwidth-\fboxsep} % Ensure the frame width matches the text width
    \@setminipage}}%
  {\par\unskip\endMakeFramed%
  \at@end@of@kframe}
\makeatother



\makeatletter
\@ifundefined{Shaded}{
}{\renewenvironment{Shaded}{\begin{kframe}}{\end{kframe}}}
\makeatother


%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Generic rmd block
\newenvironment{rmdblock}[1]
  {\setlength{\itemindent}{10em}\begin{quote}\vspace{-1em}
  \begin{itemize}\setlength{\parskip}{2mm}
  \renewcommand{\labelitemi}{
    \raisebox{-.5\height}[0pt][0pt]{
      {\setkeys{Gin}{width=1.5em,keepaspectratio}\includegraphics{icons/#1}}
    }
  }
  \setlength{\fboxsep}{1em}
  \begin{kframe}
  \item
  }
  {
  \end{kframe}
  \end{itemize}\vspace{-0.75em}\end{quote}
  }
\newenvironment{rmdblockNoIcon}
  {\begin{quote}\vspace{-0.75em}
  \setlength{\parskip}{2mm}
  %\begin{kframe}
  }
  {%\end{kframe}
  \vspace{-0.05em}\end{quote}
  }

\usepackage{tcolorbox} % Provides  \newtcolorbox

%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Objectives boxes
\definecolor{ObjColour}{RGB}{237, 237, 237}
\newtcolorbox{objectivescolourbox}{
  colback=ObjColour,
  colframe=ObjColour,
  coltext=black,
  boxsep=5pt,
  arc=4pt}

\newenvironment{objectivesBox}[1]
  {\footnotesize
  %\begin{itemize}[leftmargin=.5in]
  %\renewcommand{\labelitemi}{
  %  \raisebox{-.4\height}[0pt][0pt]{
  %    {\setkeys{Gin}{width=1.5em,keepaspectratio}
  %      \includegraphics{icons/#1}\qquad}
  %  }
  %}
  \setlength{\fboxsep}{1em}
  \begin{objectivescolourbox}\setlength{\parskip}{1mm}
  %\item
  }
  {
  \end{objectivescolourbox}
  %\end{itemize}
%  \vspace{mm}
  }  
  
  

%%%%%%%%%%%%%%%%%%%%%%%%%
% Tip boxes
\definecolor{TipColour}{RGB}{220, 220, 220}
\newtcolorbox{tipcolourbox}{
  colback=TipColour,
  colframe=TipColour,
  coltext=black,
  boxsep=5pt,
  arc=4pt}

\newenvironment{tipBox}[1]
  {\small
  \begin{itemize}[leftmargin=.5in]
  \renewcommand{\labelitemi}{
    \raisebox{-.4\height}[0pt][0pt]{
      {\setkeys{Gin}{width=1.5em,keepaspectratio}
        \includegraphics{icons/#1}\qquad}
    }
  }
  \setlength{\fboxsep}{1em}
  \begin{tipcolourbox}\setlength{\parskip}{2mm}
  \item
  }
  {
  \end{tipcolourbox}
  \end{itemize}\vspace{-1mm}
}
  
%%%%%%%%%%%%%%%%%%%%%%%%%
% Important Box
\definecolor{ImportantColour}{RGB}{220, 220, 220}
\newtcolorbox{importantcolourbox}{
  colback=ImportantColour,
  colframe=ImportantColour,
  coltext=black,
  boxsep=5pt,
  arc=4pt}
\newenvironment{importantBox}[1]
  {\small
  \begin{itemize}[leftmargin=.5in]
  \renewcommand{\labelitemi}{
    \raisebox{-.4\height}[0pt][0pt]{
      {\setkeys{Gin}{width=1.5em,keepaspectratio}
        \includegraphics{icons/#1}\qquad}
    }
  }
  \setlength{\fboxsep}{1em}
  \begin{importantcolourbox}\setlength{\parskip}{2mm}
  \item
  }
  {
  \end{importantcolourbox}
  \end{itemize}\vspace{-1mm}
  } 

%%%%%%%%%%%%%%%%%%%%%%%%%
% Software Box
\definecolor{SoftwareColour}{RGB}{220, 220, 220}
\newtcolorbox{softwarecolourbox}{
  colback=SoftwareColour,
  colframe=SoftwareColour,
  coltext=black,
  boxsep=5pt,
  arc=4pt}
\newenvironment{softwareBox}[1]
  {\small
  \begin{itemize}[leftmargin=.5in]
  \renewcommand{\labelitemi}{
    \raisebox{-.4\height}[0pt][0pt]{
      {\setkeys{Gin}{width=1.5em,keepaspectratio}
        \includegraphics{icons/#1}\qquad}
    }
  }
  \setlength{\fboxsep}{1em}
  \begin{softwarecolourbox}\setlength{\parskip}{2mm}
  \item
  }
  {
  \end{softwarecolourbox}
  \end{itemize}\vspace{-1mm}
  } 


%%%%%%%%%%%%%%%%%%%%%%%%%
% Think Box
\definecolor{ThinkColour}{RGB}{245, 245, 245}
\newtcolorbox{thinkcolourbox}{
  colback=ThinkColour,
  colframe=ThinkColour,
  coltext=black,
  boxsep=5pt,
  arc=4pt}
\newenvironment{thinkBox}[1]
  {\small
  \begin{itemize}[leftmargin=.5in]
  \renewcommand{\labelitemi}{
    \raisebox{-.4\height}[0pt][0pt]{
      {\setkeys{Gin}{width=1.5em,keepaspectratio}
        \includegraphics{icons/#1}\qquad}
    }
  }
  \setlength{\fboxsep}{1em}
  \begin{thinkcolourbox}\setlength{\parskip}{2mm}
  \item
  }
  {
  \end{thinkcolourbox}
  \end{itemize}\vspace{-1mm}
  } 



%%%%%%%%%%%%%%%%%%%%%%%%%
%%% End of chapter answer boxes
\definecolor{EOCAnswerColour}{RGB}{247, 247, 247}
\newtcolorbox{EOCanswercolourbox}{
  colback=EOCAnswerColour,
  colframe=EOCAnswerColour,
  coltext=black,
  boxsep=5pt,
  arc=4pt}
  
  \newenvironment{EOCanswerBox}[1]
  {\footnotesize
  \begin{itemize}[leftmargin=.5in]
  \renewcommand{\labelitemi}{
    \raisebox{-.4\height}[0pt][0pt]{
      {\setkeys{Gin}{width=1.5em,keepaspectratio}
        \includegraphics{icons/#1}\qquad}
    }
  }
  \setlength{\fboxsep}{1em}
  \begin{EOCanswercolourbox}\setlength{\parskip}{1mm}
  \item
  }
  {
  \end{EOCanswercolourbox}
  \end{itemize}\vspace{-2mm}
  }  



%%%%%%%%%%%%%%%%%%%%%%%%%
% Pronounce Box
\definecolor{PronounceColour}{RGB}{220, 220, 220}
\newtcolorbox{pronouncecolourbox}{
  colback = PronounceColour,
  colframe = PronounceColour,
  coltext = black,
  boxsep = 5pt,
  arc = 4pt}
\newenvironment{pronounceBox}[1]
  {\small
  \begin{itemize}[leftmargin=.5in]
  \renewcommand{\labelitemi}{
    \raisebox{-.4\height}[0pt][0pt]{
      {\setkeys{Gin}{width=1.5em,keepaspectratio}
        \includegraphics{icons/#1}\qquad}
    }
  }
  \setlength{\fboxsep}{1em}
  \begin{pronouncecolourbox}\setlength{\parskip}{2mm}
  \item
  }
  {
  \end{pronouncecolourbox}
  \end{itemize}\vspace{-1mm}
  } 



%%%%%%%%%%%%%%%%%%%%%%%%%
% Answers chapter

% Answer Box
\newenvironment{answer}
  {\footnotesize}
  {\null\vspace{-5mm}} %{\smallskip}

% ChapAnswers
\newenvironment{ChapAnswers}
  {\null\vspace{-10mm}\null\begin{multicols}{2}\footnotesize\raggedright}
  {\null\vspace{-16mm}\end{multicols}\null\vspace{-16mm}\null} %{\smallskip}



%%%%%%%%%%%%%%%%%%%%%%%%%
% Note Box
\newenvironment{rmdnote}
  {\begin{rmdblock}{iconmonstr-light-bulb-2-240}}
  {\end{rmdblock}}
  

%%%%%%%%%%%%%%%%%%%%%%%%%
% Example extra Box
% exampleExtra: Omit this is latex
\usepackage{comment}
\excludecomment{exampleExtra}

\newenvironment{darkgraytext}{\color{textcolor}}{\ignorespacesafterend}


%%% REDEFINE some environments

%%% BASED ONL
%%%   https://stackoverflow.com/questions/58195679/how-can-i-redefine-a-standard-bookdown-theorem-environment-in-latex-pdf (I asked)
%% and adapted using:
%%%   https://stackoverflow.com/questions/1565988/making-a-small-modification-to-a-latex-environment

% REDEFINE some standard environments

%%%%%%%%%%%%%%%%%%%%%%%%%
% Redefine DEFINITION
\AtBeginDocument{%
\let\origenddefinition=\enddefinition%
\let\origdefinition=\definition%
\renewenvironment{definition}%
  {\begingroup\definecolor{shadecolor}{RGB}{230, 230, 230}\vspace{2mm}% Gap between above text, and top of box/shading  
   \begin{quote}\setlength{\parskip}{1mm}%
   \vspace{-4mm}% Gap between top of box/shading and the start of the text that is inside the box
   \origdefinition
   %\vspace{5mm}% Gap between top of box/shading and the start of the text that is inside the box
   }%
  {%\vspace{5mm}% Space between text and bottom of shaded box
  \origenddefinition\end{quote}
  \vspace{2mm}% Gap between bottom of box/shading and the start of the text below
  \endgroup}}


% %%%%%%%%%%%%%%%%%%%%%%%%%
% % Redefine EXAMPLE
\AtBeginDocument{%
\let\origendexample=\endexample%
\let\origexample=\example%
\renewenvironment{example}%
  {\begingroup\definecolor{shadecolor}{RGB}{245, 245, 245}\vspace{2mm}% Gap between above text, and top of box/shading
  \begin{quote}\setlength{\parskip}{1mm}% Gap between top of shading/box and start of in-box text
  \vspace{-4mm}% Gap between top of box/shading and the start of the text that is inside the box
  \origexample
  % Last vspace adjusts space between start of gray box, and start of text
  }%
  {%\vspace{5mm}% Space between text and bottom of shaded box
  \origendexample\end{quote}
  \vspace{2mm}% Gap between bottom of box/shading and the start of the text below
  \endgroup}}% Gap between bottom of box/shading and the start of the text below


%%%%%%%%%%%%%%%%%%%%%%%%%
% Redefine EXERCISE
\AtBeginDocument{%
\let\origendexercise=\endexercise%
\let\origexercise=\exercise%
\renewenvironment{exercise}%
  {\small\begingroup\setlist{nosep,topsep=-0.8\parskip}\vspace{5mm}%
  \setlength{\parskip}{1.5mm}%
  \vspace{-5mm}\origexercise}%
  {\origendexercise\vspace{0mm}\endgroup}}
    

% % Fix the itemize/enumerate spacing in exercises:
% \let\origexercise=\exercise
% \def\exercise{\begingroup\setitemize{labelindent=1.5em,labelsep=3mm,leftmargin=*}\setenumerate{labelindent=1.5em,labelsep=3mm,leftmargin=*}\origexercise}  
%    %% -5mm removes some spacing at the top, which looked odd. Chosen by trial and error
% \let\origendexercise=\endexercise
% \def\endexercise{\origendexercise\endgroup}
%    %% \setitem  from the  enumitem  package




% Redfine some existing environments
% -QUOTE
\makeatletter
\renewenvironment{quote}
               {\list{}{%
               \vspace{-0.5em}% Top spacing, before the quote box itself
               \begin{kframe}\small%
                        \itemindent%
                        \listparindent
                        \rightmargin\leftmargin
                        \parsep        \z@ \@plus\p@}%
                \item\relax}
               {\end{kframe}\endlist\vspace{-0.25em}}
\makeatother

\let\origquote\quote
\let\origendquote\endquote
\renewenvironment{quote}{%
  \vspace{0\parskip} % Gap between text above, and start of quote shading
  \origquote
}%
{\origendquote\vspace{-0.5\parskip}}% Gap between text below, and bottom of quote shading



% Fold environment for LaTeX
\newenvironment{fold}
  {\vspace{-6pt}\begin{rmdblockNoIcon}\scriptsize \textbf{Answer:}}
  {\end{rmdblockNoIcon}}
  

% For CRC, according to `Run_This_Example.tex`:
\usepackage{hyperref}

% Some corrections to spacing
\usepackage{xspace}
\newcommand{\spacex}{\@ } % Using  \xspace  does not work for some reason

% Indexing
\makeindex
%\usepackage[nottoc,notbib]{tocbibind} # bib  already added

%\include{frontmatter/preamble} %place custom commands and macros here

%%%%% END PREAMBLE %%%%%
%%%%%

