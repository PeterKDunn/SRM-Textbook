
# Tests for the mean difference (paired data) {#TestPairedMeans}


<!-- Introductions; easier to separate by format -->
```{r, child = if (knitr::is_html_output()) {'./introductions/31-Testing-MeanDifference-HTML.Rmd'} else {'./introductions/31-Testing-MeanDifference-LaTeX.Rmd'}}
```





<!-- ```{r echo=FALSE} -->
<!-- insulate <- read.csv("./Data/InsulationBeforeAfter.csv")  -->

<!-- colnames(insulate) <- c("Before", "After") -->
<!-- insulate$Diff <- insulate$Before - insulate$After -->

<!-- mn.I <- mean(insulate$Diff) -->
<!-- sd.I <- sd(insulate$Diff) -->
<!-- n.I <- length(insulate$Diff) -->
<!-- se.I <- sd.I / sqrt(n.I) -->
<!-- ``` -->


## Introduction: total nitrogen {#PairedTTest-Intro}


<div style="float:right; width: 222x; border: 1px; padding:10px">
<img src="Illustrations/meal-3236971_1280.jpg" width="200px"/>
</div>


A study [@lambie2021microbial] compared nitrogen (N) in soils from irrigated and non-irrigated intensively grazed pasture sites.
The researchers paired irrigated and non-irrigated  sites (p. 338):

> The irrigated and non-irrigated pairs within each site were within $100$\ m of each other and were on the same soil, landform and usually the same farm with the same farm management on both treatments.

The data are *paired* (Sect.\ \@ref(PairedIntro)), which is a form of blocking (Sect.\ \@ref(ExpManagingConfounding)).
One purpose of the study was:

> For intensively grazed pastures sites, is there a mean reduction in percentage nitrogen (N) when sites are irrigated, compared to non-irrigated?

The data are shown in
`r if( knitr::is_latex_output() ) {
    'Table\\ \\@ref(tab:SoilCN).'
} else {
    'the table below.'
}`
The parameter is $\mu_d$, the population mean *reduction* in percentage N when sites are irrigated, compared to non-irrigated.


::: {.tipBox .tip data-latex="{iconmonstr-info-6-240.png}"}
Explaining *how* the differences are computed is important.  

The differences could be computed as the percentage N in *irrigated* sites minus percentage N in *non-irrigated* sites, or the percentage N in *non-irrigated* sites minus percentage N in *irrigated* sites.
Either is fine, as long as you remain consistent throughout.
The meaning of any conclusions will be the same.  

Here we discuss the percentage N in *irrigated* sites minus percentage N in *non-irrigated* sites, the *reduction* in percentage N when sites are irrigated, compared to non-irrigated.
:::


```{r}
data(SoilCN)

SoilN <- subset(SoilCN, 
                select = c(IrrigatedN, NonirrigatedN))
SoilN$Change <- SoilN$NonirrigatedN - SoilN$IrrigatedN

Nlen <- length(SoilN$TotalCI) 

if( knitr::is_latex_output() ) {
  
 T1 <- knitr::kable(surroundMaths(SoilN[1:14, ],
                                   decDigits = 2),
                     format = "latex",
                     valign = 't',
                     align = "r",
                     linesep = "",
                     col.names = c("Not irrigated", "Irrigated", "Reduction"),
                     row.names = FALSE,
                     escape = FALSE,
                     booktabs = TRUE) %>%
    row_spec(0, bold = TRUE) 
  
  
  T2 <-knitr::kable(surroundMaths(SoilN[15:28, ],
                                   decDigits = 2),
                     format = "latex",
                     valign = 't',
                     align = "r",
                     linesep = "",
                     col.names = c("Irrigated", "Not irrigated", "Reduction"),
                     row.names = FALSE,
                     escape = FALSE,
                     booktabs = TRUE) %>%
    row_spec(0, bold = TRUE)
  
  out <- knitr::kables(list(T1, T2),
                       format = "latex",
                       label = "SoilCN",
                       caption = "The percentage total nitrogen in irrigated and non-irrigated soils.") %>% 
    kable_styling(font_size = 10)
  out2 <- prepareSideBySideTable(out) 
  out2 
}

if( knitr::is_html_output() ) {
  kable( SoilN,
         format = "html",
         booktabs = TRUE,
         longtable = FALSE,
         col.names = c("Irrigated", "Not irrigated"),
         caption = "he percentage total nitrogen in irrigated and non-irrigated soils.") %>% 
    kable_styling(font_size = 10) %>%
    row_spec(0, bold = TRUE)
}
```


Since the raw data are available, the data should be summarised graphically (Fig.\ \@ref(fig:SoilNGraphs)) and numerically (Table\ \@ref(tab:SoilNSummary)), using software (Fig.\ \@ref(fig:Nitrogenjamovi)).





```{r SoilNSummary}
SoilSummary <- array( dim = c(3, 4))

rownames(SoilSummary) <- c("Non-irrigated",
                           "Irrigated",
                           "Change")
colnames(SoilSummary) <- c("Mean",
                           "Std. dev.",
                           "Std. error",
                           "Sample size")

SoilSummary[, 1] <- colMeans(SoilN)
SoilSummary[, 2] <- apply(SoilN,
                          2,
                          "sd")
SoilSummary[, 3] <- apply(SoilN,
                          2,
                          "findStdError")
SoilSummary[, 4] <- apply(SoilN,
                          2,
                          "length")

# Do some appropriate rounding
SoilSummary <- round(SoilSummary, 4)
SoilSummary[1:2, 1] <- round(SoilSummary[1:2, 1], 3)

if( knitr::is_latex_output() ) {
  
 knitr::kable(surroundMaths(SoilSummary,
                                   decDigits = NA),
                     format = "latex",
                     align = c("l", "c", "c", "c"),
                     linesep = "",
              caption = "The total percentage N in irrigated and non-irrigated sites",
                     col.names = c("Mean", "Std. dev.", "Std. error", "Sample size"),
                     row.names = TRUE,
                     escape = FALSE,
                     booktabs = TRUE) %>%
    row_spec(0, bold = TRUE) %>%
    kable_styling(font_size = 10)
  
}

if( knitr::is_html_output() ) {
  kable( SoilSummary,
         format = "html",
         booktabs = TRUE,
         longtable = FALSE,
         col.names = c("Irrigated", "Not irrigated"),
         caption = "The total nitrogen in irrigated and non-irrigated soils.") %>% 
    kable_styling(font_size = 10) %>%
    row_spec(0, bold = TRUE)
}
```




```{r, SoilNGraphs, fig.align="center", fig.cap="The reduction in percentage N when sites are irrigated, compared to non-irrigated. Left: A histogram; right: a case-profile plot (solid lines and solid dots for lower percentage N in irrigated sites).", fig.show="hold", out.width='100%', fig.width = 9.25, fig.height = 3.75}
par( mfrow = c(1, 2))

hist(SoilN$Change,
     main = "Case-profile plot\nof nitrogen reduction",
     xlab = "Reduction in %N",
     ylab = "No. of sites",
     las = 1)

box()

plot( x = c(0.75, 2.25),
      y = c(0.15, 0.7),
      axes = FALSE,
      type = "n",
      main = "Case-profile plot\nof nitrogen reduction",
      xlab = "",
      ylab = "Change in % N")
axis(side = 1,
     at = 1:2,
     labels = c("Irrigated",
                "Non-irrigated") )
axis(side = 2,
     las = 1)
box()

delta <- 0.02
for (i in 1:length(SoilN$Change)){
  lines( x = c(1 + ifelse(SoilN$Change[i] > 0, delta, -delta), 
               2 + ifelse(SoilN$Change[i] > 0, delta, -delta)),
         y = c( SoilN$IrrigatedN[i], 
                SoilN$NonirrigatedN[i]),
         lty = ifelse(SoilN$Change[i] > 0, 1, 2),
         type = "b",
         pch = ifelse(SoilN$Change[i] > 0, 19, 1))
}
box()

```


```{r Nitrogenjamovi, fig.cap="jamovi output for the nitrogen data", fig.align="center", out.width=c("60%","100%"), fig.show='hold'}
knitr::include_graphics("jamovi/SoilCN/SoilCN-Summary.png")
knitr::include_graphics("jamovi/SoilCN/SoilCN-Testing.png")
```


## Statistical hypotheses and notation

The RQ asks if the mean total nitrogen *reduces* in the *population* when sites are irrigated; that is, is the mean difference is zero, or less than zero, provided the difference is defined as the percentage N in irrigated sites minus non-irrigated sites.
The *parameter* is the *population mean difference*. 
The notation used (recapping Sect.\ \@ref(PairedNotationCI)) is:

* $\mu_d$: The mean *difference* in the *population*.
* $\bar{d}$: The mean *difference* in the *sample*.
* $s_d$: The *sample* standard deviation of the *differences*.
* $n$: The number of *differences*.

The hypotheses, therefore, can be written in terms of the parameter $\mu_d$.
The *null* hypothesis is 'there is *no change* in percentage N, in the population':

* $H_0$: $\mu_d = 0$.

The null hypothesis states is 'no difference, no change, no relationship' (Sect.\ \@ref(AboutHypotheses)), as measured by a parameter value.
This hypothesis, the initial *assumption*, postulates that the mean reduction may not be zero in the *sample* due to sampling variation.

Since the RQ asks specifically if mean percentage N *decreases*, the alternative hypothesis is [*one-tailed*](#AboutHypotheses).
According to how the differences have been defined, the alternative hypothesis is:

* $H_1$: $\mu_d < 0$ (i.e., one-tailed).

This hypothesis says that the mean reduction in the population is *less than* zero, because of the wording of the RQ and because of how the diffference were defined.
(If the differences had been defined in the opposite way-- as 'the percentage N in *non-irrigated* sites minus *irrigated* sites'--- then the alternative hypothesis would be $\mu_d < 0$, which has the same *meaning*.)


##  Describing the sampling distribution

The *sample* percentage N reduction will vary depending on which one of the many possible samples is randomly obtained, *even if* the mean reduction in the population is zero.
That is, the value of $\bar{d}$ will vary across all possible samples even if $\mu_d = 0$.

The possible values of the sample mean differences can, under certain conditions (Sect.\ \@ref(ValiditySampleMeanDiffTest)), be described using an approximate normal distribution.
Hypothesis testing begins by assuming that the null hypothesis is true; i.e., that $\mu_d = 0$.
The standard deviation of all the possible values of $\bar{d}$ (called the *standard error*) is denoted $\text{s.e.}(\bar{d})$, and it's value is  
\[
  \text{s.e.}(\bar{d}) = s_d/\sqrt{n} = 0.062/\sqrt{28} = 0.0117.
\]
This describes what can be *expected* from the possible values of $\bar{d}$ (Fig.\ \@ref(fig:PercentageNSamplingDist)), just through sampling variation if $\mu_d = 0$.



```{r PercentageNSamplingDist, fig.cap="The sampling distribution is a normal distribution; it describes how the sample mean reduction in percentage N varies in samples of size $n = 28$ when the population mean reduction is $0$", fig.align="center", fig.width=9.0, fig.height=2.5, out.width='95%'}
mn <- mean(SoilN$Change)
n <- length(SoilN$Change)
stdd <- sd(SoilN$Change)

se <- stdd/sqrt(n)

par( mar = c(4, 0.5, 0.5, 0.5) )
out <- plotNormal(0,
                  se,
                  xlab = "N difference (%)", 
                  cex.axis = 0.95,
                  ylim = c(0, 55),
                  showXlabels = c( 	
                    expression( -0.0352),
                    expression( -0.0234), 
                    expression( -0.0117), 
                    expression( 0 ),
                    expression( 0.0117), 
                    expression( 0.0234), 
                    expression( 0.0352) ) )

arrows(x0 = 0,
       x1 = 0,
       y0 = 45,
       y1 = max(out$y),
       angle = 15,
       length = 0.1)

text(x = 0,
     y = 45,
     pos = 3,
     labels = expression(Sampling~mean))



arrows(x0 = 0,
       x1 = 0 + se,
       y0 = 0.30 * max(out$y),
       y1 = 0.30 * max(out$y),
       code = 3, # Arrows both ends
       angle = 15,
       length = 0.1)

text(x = 0 + (se / 2),
     y = 0.30 * max(out$y),
     labels = expression( atop(Std.~error,
                               s.e.(bar(italic(d)))==0.0117)) )


arrows(x0 = mn,
       x1 = mn,
       y0 = 0.7 * max(out$y),
       y1 = 0,
       angle = 15,
       length = 0.1)
text(x = mn,
     y = 0.7 * max(out$y),
     pos = 3,
     labels = expression(bar(italic(x)) == 0.0282) )
```


## Computing the test statistic

The sample mean difference can be located on the sampling distribution (Fig.\ \@ref(fig:WeightGainNormal2)) by computing the $t$-score:  
\[
	t
	= \frac{\bar{d} - \mu_{d}}{\text{s.e.}(\bar{d})}
	= \frac{0.0282 - 0}{0.0117} = 2.41,
\]
following the ideas in Eq.\ \@ref(eq:tscore).
Software computes the $t$-score too (Fig.\ \@ref(fig:TotalNOutputHT)).
The $t$-score locates the *observed* sample statistic on the sampling distribution (Fig.\ \@ref(fig:Nitrogenjamovi)).



## Determining $P$-values

A $P$-value determines if the sample data are consistent with the assumption (Table\ \@ref(tab:PvaluesInterpretation)).
Since $t = 2.41$, and since $t$-scores are like $z$-scores, the *one-tailed* $P$-value is small, based on the [68--95--99.7 rule](#def:EmpiricalRule).
Software (Fig.\ \@ref(fig:TotalNOutputHT)) reports that the *two-tailed* $P$-value is $0.02279$.
Hence, the one-tailed $P$-value is $0.02279/2 = 0.0114$.


::: {.importantBox .important data-latex="{iconmonstr-warning-8-240.png}"}
The jamovi software clarifies *how* the differences have been computed:
At the left of the output, the order implies the differences are found as `NonirrigatedN` minus `IrrigatedN`.

:::

`r if (knitr::is_latex_output()) '<!--'`
::: {.thinkBox .think data-latex="{iconmonstr-light-bulb-2-240.png}"}
<iframe src="https://learningapps.org/watch?v=pj3pt56fk22" style="border:0px;width:100%;height:500px" allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true"></iframe>
:::
`r if (knitr::is_latex_output()) '-->'`


## Writing conclusions

The *one-tailed* $P$-value is $0.0114$, suggesting moderate evidence (Table\ \@ref(tab:PvaluesInterpretation)) to support $H_1$.
A conclusion requires an *answer to the RQ*, a summary of the *evidence* leading to that conclusion, and some *summary statistics*, including a CI (indicating the precision of the statistic; Chap.\ \@ref(PairedIntro)):

> Moderate evidence exists in the sample (paired $t = 2.41$; one-tailed $P = 0.0114$) of a mean reduction in percentage N  from irrigated to non-irrigated sites (mean reduction: $0.0282$%; $n = 28$; $95$% CI from $0.0042$% to $0.0522$%).

The wording implies the direction of the differences.


## Statistical validity conditions {#ValiditySampleMeanDiffTest}

As with any hypothesis test, these results apply [under certain conditions](#exm:StatisticalValidityAnalogy).
For a hypothesis test for the mean of paired data, these conditions are the same as for the CI for the mean difference for paired data (Sect.\ \@ref(ValidityPaired)), and similar to those for one sample mean.

The test above is statistically valid if *one* of these conditions is true:

1. The sample size of differences is at least $25$; *or*
1. The sample size of differences is smaller than $25$, *and* the *population* of *differences* has an approximate normal distribution.

The sample size of $25$ is a rough figure here, and some books give other values (such as $30$).
This condition ensures that the *distribution of the sample means has an approximate normal distribution* (so that, for example, the [68--95--99.7 rule](#def:EmpiricalRule) can be used).

Provided the sample size is larger than about $25$, this will be approximately true *even if* the distribution of the individuals in the population does not have a normal distribution.
That is, when $n > 25$ the sample means generally have an approximate normal distribution, even if the data themselves don't have a normal distribution.


::: {.example #StatisticalValidityWeightLossHT name="Statistical validity"}
For the percentage N data, the sample size is $n = 28$, so the test is statistically valid.
:::


## Example: Physical activity

A study of $n = 213$ Spanish health students [@romero2020physical] measured the number of minutes of vigorous physical activity (PA) performed by students *during* and *before* the COVID-19 lockdown (in Spain: March to April 2020).
These numerical summary of the data are shown in Table\ \@ref(tab:COVIDsummaryTable2).



```{r COVIDsummaryTable2}
COVID.summary     <- array( dim = c(3, 2))
colnames(COVID.summary) <- c("Mean (mins)", 
                             "Std dev (mins)")
rownames(COVID.summary) <- c("Before",
                             "During",
                             "Increase")


COVID.summary[1, ] <- c(28.47,
                        54.13)
COVID.summary[2, ] <- c(30.66,
                        30.04)
COVID.summary[3, ] <- c(2.68,
                        51.30)


if( knitr::is_latex_output() ) {
  knitr::kable( surroundMaths(COVID.summary,
                              decDigits = 2),
               format = "latex",
               booktabs = TRUE,
               longtable = FALSE,
               escape = FALSE,
               caption = "Summary information for the COVID-lockdown exercise data",
               align = c("r", "r")) %>%
    row_spec(0, bold = TRUE) %>%
    row_spec(3, italic = TRUE) %>%
    kable_styling(font_size = 10)
} 
if( knitr::is_html_output() ) {
   knitr::kable( COVID.summary,
                 format = "html",
                 caption = "Summary information for the COVID-lockdown exercise data")
}
```


Define the *differences* as the number of minutes of vigorous PA *during* the COVID lockdown, minus the number of minutes of vigorous PA *before* the COVID lockdown.
With this definition, a *positive* difference means the *during* value is higher; hence, the differences correspond to the *increase* in PA during (compared to before) the COVID lockdown.
The RQ is

> For Spanish health students, is there a mean change in the amount of vigorous PA during and before the COVID lockdown? 
  
The *parameter* of interest is the population mean difference $\mu_d$, the mean *decrease* in vigorous PA *during* (compared to before) the lockdown.
The hypotheses are:  
\[
   \text{$H_0$: $\mu_d = 0$}\quad\text{and}\quad \text{$H_1$: $\mu_d \ne 0$} \quad\text{(i.e., two-tailed)}.
\]
The mean *difference* is $\bar{d} = 2.68$\ mins, with a standard deviation of $s_d = 51.30$\ mins.
However, the sample mean difference varies from sample to sample, so has a standard error:
$\text{s.e.}(\bar{d}) = s_d\div \sqrt{n} = {51.30}\div{\sqrt{213}} = 3.515018$.
The test statistic is  
\[
  t = \frac{\bar{d} - \mu_{\bar{d}}}{\text{s.e.}(\bar{d})} = \frac{2.68 - 0}{3.515018} = 0.76.
\]

This is a very small value; using the 68--95--99.7 rule the $P$-value will be very large (larger than $0.32$); software gives $P = 0.448$.
Hence, a sample mean difference of $2.68$\ mins is not unlikely when the population mean difference was zero.

We write:

> No evidence (paired $t = 0.76$, $P = 0.448$) exists in the sample of a mean difference in the mean change in vigorous PA *during* (compared to *before*) lockdown (sample mean $2.68$\ mins greater *during* lockdown; standard deviation: $51.30$\ mins; approximate $95$% CI: $-4.35$ to $9.71$\ mins) in the population.

Since $n = 213$, which is much larger than $25$, the test is statistically valid.




## Example: endangered species: REMOVE {#EndangeredHT}

A study of endangered species [@harnish2020attitudes] examined (p. 1703)

> ...whether perceived physical attractiveness of a species impacted participants' attitudes toward supporting and protecting the species...

To do so, $210$ undergraduate students were surveyed about $14$ animals on various aspects of supporting and protecting them.
Part of the data are summarised in Table\ \@ref(tab:AnimalsData), for two animals when asked about 'support to protect the animal from illicit trade'.
*Larger* values means *greater* support for protecting the animal from illicit trade.




```{r AnimalsData}
AnimalsArray <- array( dim = c(3, 2))

AnimalsArray[1, ] <- c(3.10,
                       1.06)
AnimalsArray[2, ] <- c(2.33,
                       1.13)
AnimalsArray[3, ] <- c(0.77,
                       1.07)
rownames(AnimalsArray) <- c("Bay Checkerspot Butterfly",
                            "Valley Elderberry Longhorn Beetle",
                            "Difference")

if( knitr::is_latex_output() ) {
  kable(surroundMaths(AnimalsArray,
                      decDigits = 2),
        format = "latex",
        booktabs = TRUE,
        longtable = FALSE,
        align = "c",
        escape = FALSE,
        col.names = c("Mean of scores",
                      "Standard deviation of scores"),
        caption = "The support for protecting two animals from illicit trade") %>%
    kable_styling(font_size = 10) %>%
    row_spec(0, bold = TRUE) %>%
    row_spec(3, italic = TRUE)
}

if( knitr::is_html_output() ) {
  kable(AnimalsArray,
        format = "html",
        booktabs = TRUE,
        longtable = FALSE,
        col.names = c("Mean of scores",
                      "Standard deviation of scores"),
        caption = "The support for protecting two animals from illicit trade") %>%
    kable_styling(font_size = 10) %>%
    row_spec(0, bold = TRUE) %>%
    row_spec(3, italic = TRUE)
}
```


(Notice that the standard deviation of the difference is **not** the difference between the two given values of the standard deviation.)

The *difference* is defined as each student's score for the butterfly (deemed more attractive) *minus* their score for the beetle (deemed less attractive).
A positive value therefore means more support (on average) for the butterfly.
The RQ is whether there is a mean difference between support for each animal, so the parameter is $\mu_d$, the population mean difference.

The researchers wished to test if (p. 1704)

> ...animals perceived as more physically attractive [i.e., the butterfly] compared to those which are perceived as less physically attractive [i.e., the beetle] will receive relatively more support to prevent the species from illicit trade

Given how the difference are defined, the hypotheses are:  
\[
   H_0: \mu_d = 0\quad\text{and}\quad H_1: \mu_d > 0 \quad\text{(i.e., one-tailed, based on the researchers' purpose)}
\]
The mean difference is $\bar{d} = 0.77$ and $s_d = 1.07$.
The value of $\bar{d}$ will vary from sample to sample with a mean of $\mu(\bar{d}) = 0$, and a standard error of:  
\[
   \text{s.e.}(\bar{d}) = \frac{s_d}{\sqrt{n}} = \frac{1.07}{\sqrt{210}} = 0.073837.
\]
The value of the test statistic is  
\[
   t = \frac{\bar{d} - \mu_{\bar{d}}}{\text{s.e.}(\bar{d})} = \frac{0.77 - 0}{0.073837} = 10.43,
\]
which is a *very* large value. 
Hence, the $P$-value will be very small, certainly less than $0.05$.
Since the sample size is much larger than $25$, the test will be statistically valid.

We write:

> There is very strong evidence ($t = 10.43$; one-tailed $P < 0.001$) that the mean difference in support for protecting the Bay Checkerspot Butterfly from illicit trade is greater than support for protecting the Valley Elderberry Longhorn Beetle from illicit trade (mean difference: $0.77$; standard deviation: $1.07$; $95$% CI for the difference: $0.62$ to $0.92$).


## Example: blood pressure: REMOVE {#Diabetes}


```{r}
data(Diabetes)

Diabetes$Diff <- Diabetes$SBPfirst - Diabetes$SBPsecond

n.D.diff <- length( Diabetes$Diff ) - sum( is.na(Diabetes$Diff) )
se.D.diff <- sd(Diabetes$Diff) / sqrt(n.D.diff)
```


<div style="float:right; width: 222x; border: 1px; padding:10px">
<img src="Illustrations/hush-naidoo-pA0uoltkwao-unsplash.jpg" width="200px"/>
</div>


A US study [@data:Willems1997:CHD; @data:Schorling1997:smoking] was conducted to determine how CHD risk factors were assessed among parts of the population.
Subjects were required to report to the clinic on multiple occasions.

One RQ of interest is:

> Is there a mean difference in blood pressure measurements between the first and second visits? 

The parameter is $\mu_d$, the population mean *reduction* in blood pressure.
Each person has a *pair* of diastolic blood pressure (DBP) measurements: One each from their first and second visits.
The data
`r if (knitr::is_latex_output()) {
   '(Table\\ \\@ref(tab:DiabetesDataTable))'
} else {
   'shown below,'
}`
are from $141$ people.
(These data were also seen in Sect.\ \@ref(BloodPressure).)
The differences could be computed in one of two ways:   

* The observation from the first visit, minus the observation from the second visit: the *reduction* in BP; or
* The observation from the second visit, minus the observation from the first visit: the *increase* in BP.

Either way is fine, as long as the order remains consistent, and the direction is made clear.
Here, the observations from the *first* visit minus the observation from the *second* visit will be used, so that the differences represent the *decrease* in BP
from the first to second measurement.


```{r DiabetesDataTable2}
DiffExists <- complete.cases(Diabetes[, c("DBPfirst", 
                                      "DBPsecond", 
                                      "Diff")])
diabData <- Diabetes[DiffExists, c("DBPfirst", 
                               "DBPfirst", 
                               "Diff")]

if( knitr::is_latex_output() ) {
  diabData <- rbind( head(diabData),
                     c("$\\vdots$", "$\\vdots$", "$\\vdots$") )

knitr::kable(surroundMaths(diabData),
             format = "latex",
             booktabs = TRUE,
             longtable = FALSE,
             escape = FALSE,
             linesep = "",
             row.names = FALSE,
             align = "r",
             label = "DiabetesDataTable2",
             caption = "The diastolic blood pressure data; the first six patients only",
             col.names = c("DBP: 1st visit", "DBP: 2nd visit", "Reduction in DBP") ) %>%
  row_spec(row = 0, bold = TRUE) %>%
  #row_spec(row = 3, bold = TRUE) %>%
  kable_styling(font = 10)
}

if( knitr::is_html_output() ) {
  kable( head(diabData, 15),
         format = "html",
         booktabs = TRUE,
         longtable = FALSE,
             col.names = c("DBP: 1st visit", "DBP: 2nd visit", "Reduction in DBP"), 
             caption = "The diastolic blood pressure data; the first fifteen patients only") %>%
  kable_styling(font_size = 10) %>%
  #row_spec(row = 3, bold = TRUE) %>%
  row_spec(0, bold = TRUE)
}
```

The appropriate graphical summary is a histogram of differences 
`r if (knitr::is_latex_output()) {
   '(Fig.\\ \\@ref(fig:DiabetesHIST));'
} else {
   '(Fig.\\ \\@ref(fig:DiabetesHIST2));'
}`
the numerical summary is shown in  Table\ \@ref(tab:DiabSummTable2).
Notice that having the information about the differences is essential, as the RQ is about the differences.


```{r DiabSummTable2}
Diab.Table <- array( dim = c(3, 4))

n.diab <- function(x){
  length(x) - sum( is.na(x))
}

se.diab <- function(x) {
  sd(x, na.rm = TRUE) / sqrt(n.diab(x) )
}

Diab.Table[1, 1] <- mean(Diabetes$DBPfirst[DiffExists], na.rm = TRUE)
Diab.Table[2, 1] <- mean(Diabetes$DBPsecond[DiffExists], na.rm = TRUE)
Diab.Table[3, 1] <- mean(Diabetes$Diff[DiffExists], na.rm = TRUE)

Diab.Table[1, 2] <- sd(Diabetes$DBPfirst[DiffExists], na.rm = TRUE)
Diab.Table[2, 2] <- sd(Diabetes$DBPsecond[DiffExists], na.rm = TRUE)
Diab.Table[3, 2] <- sd(Diabetes$Diff[DiffExists], na.rm = TRUE)

Diab.Table[1, 3] <- se.diab(Diabetes$DBPfirst[DiffExists])
Diab.Table[2, 3] <- se.diab(Diabetes$DBPsecond[DiffExists])
Diab.Table[3, 3] <- se.diab(Diabetes$Diff[DiffExists])

Diab.Table[1, 4] <- n.diab(Diabetes$DBPfirst[DiffExists])
Diab.Table[2, 4] <- n.diab(Diabetes$DBPsecond[DiffExists])
Diab.Table[3, 4] <- n.diab(Diabetes$Diff[DiffExists])

rownames(Diab.Table) <- c("DBP: First visit", 
                          "DBP: Second visit", 
                          "Decrease in DBP")

if( knitr::is_latex_output() ) {
kable(surroundMaths(Diab.Table,
                    decDigits = c(2, 3, 3, 0)),
      format = "latex",
      booktabs = TRUE,
      longtable = FALSE,
      escape = FALSE,
      align = "r",
      col.names = c("Mean", 
                    "Standard deviation", 
                    "Standard error", 
                    "Sample size"),
      digits = c(2, 3, 3, 0),
      caption = "The numerical summary for the diabetes data (in mm Hg). The differences are the second visit value minus the first visit value: the decreases in diastolic blood pressure from the first to second visit") %>%
    row_spec(0, bold = TRUE) %>%
    row_spec(3, italic = TRUE) %>%
    kable_styling(font_size = 10)
}
if( knitr::is_html_output() ) {
kable(Diab.Table,
      format = "html",
      booktabs = TRUE,
      longtable = FALSE,
      col.names = c("Mean", 
                    "Standard deviation", 
                    "Standard error", 
                    "Sample size"),
      digits = c(2, 3, 3, 0),
      caption = "The numerical summary for the diabetes data (in mm Hg). The differences are the second visit value minus the first visit value: the decreases in diastolic blood pressure from the first to second visit") %>%
    row_spec(3, italic = TRUE)
}
```


As always (Sect.\ \@ref(AboutHypotheses)), the null hypothesis is the 'no difference, no change, no relationship' position, proposing that the mean difference in the population is non-zero due to sampling variation:

* $H_0$: $\mu_d = 0$ (differences: $\text{first} - \text{second}$); \quad\text{and}\quad $H_1$: $\mu_d \ne 0$.

The alternative hypothesis is *two-tailed* because of the wording of the RQ.
As usual, *assume* that $H_0$ is true, and then the evidence is evaluated to determine if it contradicts this assertion.

The sampling distribution describes how the sample mean difference is *expected*  to vary from sample to sample due to sampling variation, when $\mu_d = 0$.
Under certain circumstances, the sample mean differences are likely to vary with a normal distribution, with a mean of $\mu_{\bar{d}} = 0$ (from $H_0$) and a standard deviation of $\text{s.e.}(\bar{d}) = 0.676$.

The relative value of the *observed* sample statistic is found by computing a $t$-score, using software (jamovi: Fig.\ \@ref(fig:DiabetesTestjamovi); SPSS: Fig.\ \@ref(fig:DiabetesTestSPSS)), or manually (Eq.\ \@ref(eq:tscore), using the information in Table\ \@ref(tab:DiabSummTable2)):  
\begin{align*}
  t 
  &= \frac{\text{sample statistic} - \text{mean of all sample statistics}}
         {\text{standard error of the statistic}}\\
  &= \frac{\bar{d} - \mu_{\bar{d}}}{\text{s.e.}(\bar{d})} \\
  &= \frac{1.950 - 0}{0.676} = 2.885.
\end{align*}
Either way, the $t$-score is the same.


```{r DiabetesTestjamovi, fig.cap="jamovi output for the diabetes data", fig.align="center",  out.width="90%"}
knitr::include_graphics("jamovi/Diabetes/Diabetes-Test-All.png")
```

```{r DiabetesTestSPSS, fig.cap="SPSS output for the diabetes data", fig.align="center", out.width="80%"}
knitr::include_graphics("SPSS/Diabetes/Diabetes-Test-NoCorr.png")
```


A $P$-value is then needed to decide if the sample is *consistent* with the assumption.
Using the [68--95--99.7 rule](#def:EmpiricalRule), the approximate two-tailed $P$-value is much smaller than $0.05$.
Alternatively, the software output (Fig.\ \@ref(fig:DiabetesTestjamovi); Fig.\ \@ref(fig:DiabetesTestSPSS)) reports the two-tailed $P$-value as $P = 0.005$.
We conclude:

> Strong evidence exists in the sample (paired $t = 2.855$; two-tailed $P = 0.005$) of a population mean difference between the first and second DBP readings (mean difference $1.95$\ mm Hg higher for first reading; $95$% CI\ from $0.61$ to $3.3$\ mm Hg; $n = 141$).

Since $n > 25$, the results are statistically valid.

::: {.importantBox .important data-latex="{iconmonstr-warning-8-240.png}"}
Just saying 'there is evidence of a difference' is insufficient.
You must state *which* measurement is, on average, higher (that is, what the differences *mean*).
:::


<iframe src="https://learningapps.org/watch?v=pj3pt56fk22" style="border:0px;width:100%;height:500px" allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true"></iframe>



## Summary {#Chap29-Summary}

Consider testing a hypothesis about a population mean difference $\mu_d$, based on the value of the sample mean difference $\bar{d}$.
Under certain statistical validity conditions, the sample mean difference varies with an approximate normal distribution centred around $\mu_{\bar{d}}$ (whose value is the hypothesised value of $\mu_d$), and with a standard deviation of  
\[
   \text{s.e.}(\bar{d}) = \frac{s_d}{\sqrt{n}}.
\]
This distribution describes what values of the sample mean difference could be **expected** if the value of $\mu_d$ in the null hypothesis was true.
The *test statistic* is  
\[
   t = \frac{ \bar{d} - \mu_{\bar{d}}}{\text{s.e.}(\bar{d})},
\]
where $\mu(\bar{d})$ is mean of all the possible sample mean differences; its value is the hypothesised value in the null hypothesis.
The $t$-score describes what value of $\bar{d}$ was **observed** in the sample, relative to what was expected.
The $t$-value is like a $z$-score, so an approximate **$P$-value** can be estimated using the [68--95--99.7 rule](#def:EmpiricalRule), or is found using software.
The $P$-values helps determine if the sample evidence is consistent with the assumption, or contradicts the assumption.


`r if (knitr::is_html_output()){
  'The following short video may help explain some of these concepts:'
}`



<div style="text-align:center;">
```{r}
htmltools::tags$video(src = "./videos/PairedTTest.mp4", 
                      width = "550", 
                      controls = "controls", 
                      loop = "loop", 
                      style = "padding:5px; border: 2px solid gray;")
```
</div>


## Quick review questions {#Chap29-QuickReview}

::: {.webex-check .webex-box}
A study [@bacho2019effects] compared joint pain in stroke patients before and after a supervised exercise treatment.
The same participants ($n = 34$) were assessed *before* and *after* treatment.

The mean *improvement* in joint pain after $13$ weeks was $1.27$ (with a standard error of $0.57$) using a standardised tool.

1. True or false? Only 'before and after' studies can be paired. \tightlist
`r if( knitr::is_html_output() ) { torf( answer=FALSE )}`
1. True or false? The null hypothesis is about the population mean *difference*.
`r if( knitr::is_html_output() ) { torf( answer=TRUE )}`
1. The value of the test statistic (to two decimal places) is
`r if( knitr::is_html_output() ) { fitb( answer = 2.23, num = TRUE, tol = 0.01 )} else {"________________."}`
1. The two-tailed $P$-value will be
`r if( knitr::is_html_output() ) {mcq( 
	c(answer = "Very small",
		"Small",
    "About 0.05",
		"Large",
		"Very large")
)} else {"________________."}`
:::



## Exercises {#TestPairedMeansExercises}

Selected answers are available in Sect.\ \@ref(TestPairedMeansAnswer).

::: {.exercise #TestPairedMeansTasteOfBrocolli}
(These data were also seen in Exercise\ \@ref(exr:PairedCIExercisesBrocolli).)
People often struggle to eat the recommended intake of vegetables.
In one study exploring ways to increase vegetable intake in teens [@data:Fritts2018:Vegetables], teens rated the taste of raw broccoli, and raw broccoli served with a specially-made dip.


Each teen ($n = 101$) had a *pair* of measurements: the taste rating of the broccoli *with* and *without* dip.
Taste was assessed using a '$100$\ mm visual analog scale', where a *higher* score means a *better* taste.
In summary:

* For raw broccoli, the mean taste rating was $56.0$ (with a standard deviation of $26.6$);
 <!-- %  (SDs); so if $n = 100$ we'd get SE: 2.647 -->
* For raw broccoli served with dip, the mean taste rating was $61.2$ (with a standard deviation of $28.7$).

Because the data are paired, the *differences* are the best way to describe the data.
The mean difference in the ratings was $5.2$, with standard error of $3.06$. 
<!-- (working backwards from the $t$-score). Looks like $n = 101$. -->

Perform a hypothesis test to see if the use of dip increases the mean taste rating.
:::


```{r}
data(Captopril)

blood <- Captopril

blood$Differences <- blood$Before - blood$After

bloodS <- subset(blood, BP=="S")
bloodS <- bloodS[, c("Before", 
                     "After", 
                     "Differences")]

bloodS2 <- cbind( "Before" = bloodS$Before[1:8], 
                  "After" = bloodS$After[1:8],
                  "Before" = c(bloodS$Before[9:15], NA), 
                  "After" = c(bloodS$After[9:15], NA) )
```


::: {.exercise #TestPairedMeansCaptopril}
(This study was also seen in Exercise\ \@ref(exr:PairedCIExercisesCaptopril).)
In a study of hypertension [@data:hand:handbook; @data:macgregor:essential], patients were given a drug (Captopril) and their systolic blood pressure measured (in mm Hg) immediately before and two hours after being given the drug (data with Exercise\ \@ref(exr:PairedCIExercisesCaptopril)).

The aim is to see if there is evidence of a *reduction* in blood pressure after taking Captopril.
Using these data and the software output (Fig.\ \@ref(fig:CaptoriljamoviHT)):

1. Explain why it is probably more sensible to compute differences as the *Before* minus the *After* measurements. 
   What do the differences *mean* when computed this way?
1. Compute the differences.
1. Construct a suitable graph for the differences.
1. Write down the hypotheses.
1. Write down the $t$-score.
1. Write down the $P$-value.
1. Write a conclusion.
:::

    

```{r CaptoriljamoviHT, fig.cap="jamovi (top) and SPSS (bottom) output for the Captoril data", fig.align="center", out.width="80%", fig.show="hold"}
knitr::include_graphics("jamovi/CaptoprilAll/CaptoprilAll-PairedTOutput.png") 
knitr::include_graphics("SPSS/CaptoprilAll/CaptoprilAll-PairedTOutput.png") 
```


::: {.exercise #TestPairedMeansSmokingAndExercise}
(This study was also seen in Exercise\ \@ref(exr:PairedCIExercisesSmokeExercise).)
A study [@data:Allen2018:Smoking] examined the effect of exercise on smoking.
Men and women were assessed on a range of measures, including the 'intention to smoke'.

'Intention to smoke', and other measures, were assessed both before and after exercise for each subject, using two quantitative questionnaires.
Smokers (defined as people smoking at least five cigarettes per day) aged $18$ to $40$ were enrolled for the study.
For the $23$ women in the study, the mean intention to smoke after exercise *reduced* by $0.66$ (with a standard error of $0.37$).

Perform a hypothesis test to determine if there is evidence of a population mean reduction in intention-to-smoke for women after exercising.
:::


```{r}
data(Ferritin)

FR <- Ferritin
FR <- dplyr::select(FR,
                    September,
                    March,
                    Reduction)
```


::: {.exercise #TestPairedMeansFerritin}
In a study [@cressie1984use] conducted at the Adelaide Children's Hospital:

> ...a group of beta thalassemia patients [...] were treated by a continuous infusion of desferrioxamine, in order to *reduce* their ferritin content...
>
> --- @cressie1984use, p. 107; emphasis added

Using the data 
`r if (knitr::is_latex_output()) {
   'in Table\\ \\@ref(tab:FerritinTable),'
} else {
   'shown below,'
}`
conduct a hypothesis test to determine if there is evidence that the treatment reduces the ferritin content, as intended.
:::

```{r FerritinTable}
if( knitr::is_latex_output() ) {
  T1 <- kable( surroundMaths(FR[1:7, ]),
               format = "latex",
               row.names = FALSE,
               escape = FALSE,
               align = "r",
               col.names = c("Sept.", "March", "Reduction"),
               booktabs = TRUE, 
               linesep = c("", "", "", "\\addlinespace"),
               longtable = FALSE) %>%
    row_spec(0, bold = TRUE)
  T2 <- kable( surroundMaths(rbind(FR[8:13, ], c(NA, NA, NA))),
               format = "latex",
               row.names = FALSE,
               escape = FALSE,
               align = "r",
               col.names = c("Sept.", "March", "Reduction"),
               booktabs = TRUE,
               linesep = c("", "", "", "\\addlinespace"),
               longtable = FALSE) %>%
    row_spec(0, bold = TRUE)
  T3 <- kable( surroundMaths(FR[14:20, ]),
               format = "latex",
               row.names = FALSE,
               escape = FALSE,
               align = "r",
               col.names = c("Sept.", "March", "Reduction"),
               booktabs = TRUE,
               linesep = c("", "", "", "\\addlinespace"),
               longtable = FALSE) %>%
    row_spec(0, bold = TRUE) 
  
  out <- knitr::kables(list(T1, T2, T3),
                       format = "latex",
                       label = "FerritinTable",
                       caption = "The ferritin content (in $\\mu$g/L) for 20 thalassemia patients at the Adelaide Children's Hospital") %>% 
    kable_styling(font_size = 10)  
  out2 <- prepareSideBySideTable(out, 
                                 numberOfTables = 3,
                                 gap = "\\quad") 
  out2
}
if( knitr::is_html_output()) {
  kable( head(FR, 10),
        format = "html",
        longtable = FALSE,
        caption = "The ferritin content (in $\\mu$g/L) for 20 thalassemia patients at the Adelaide Children's Hospital (first ten observations)",
        booktabs = TRUE)
}
```


::: {.exercise #StressSurgeryHT}
(This study was also seen in Exercise\ \@ref(exr:StressSurgeryHT).)
The concentration of beta-endorphins in the blood is a sign of stress.
One study (@data:hand:handbook, Dataset 232; @hoaglin2011exploring) measured the beta-endorphin concentration for $19$ patients about to undergo surgery.
The RQ was: "For patients approaching surgery, is there a mean increase in beta-endorphin concentrations?"

Each patient had their beta-endorphin concentrations measured $12$--$14$ hours before surgery, and also $10$ minutes before surgery.
A numerical summary can be produced from jamovi output (Fig.\ \@ref(fig:StressDescriptivesjamovi)).
Use the output to test the RQ.
:::

```{r StressDescriptivesjamovi, fig.cap="", fig.align="center", out.width='80%'}
data(Stress)

ST <- Stress

StressTab <- data.frame(
  "Means" = c( colMeans(ST),
               mean(ST$BeforeMins - ST$BeforeHours) ),
  "Std deviation" = c( apply(ST, 2, "sd"),
                       sd(ST$BeforeMins - ST$BeforeHours) ),
  "Std Error" = c( apply(ST, 2, function(x){sd(x)/sqrt(length(x))}),
                   sd(ST$BeforeMins - ST$BeforeHours)/sqrt(19) ),
  "Sample size" = c( apply(ST, 2, length),
                     length(ST$BeforeMins - ST$BeforeHours) )
)
rownames(StressTab) <- c("12--14 hours before surgery",
                         "10 minutes before surgery",
                         "Increase")
  
if( knitr::is_latex_output() ) {
  knitr::kable(surroundMaths(StressTab,
                             decDigits = c(2, 2, 2, 0)),
               format = "latex",
               align = "r",
               booktabs = TRUE,
               longtable = TRUE,
               escape = FALSE,
               caption = "The surgery-stress data",
               col.names = c("Sample mean",
                             "Std deviation",
                             "Std error",
                             "Sample size"),
               row.names = TRUE,
               digits = 2)%>%
     row_spec(0, bold = TRUE) %>%
     row_spec(3, italic = TRUE) %>%
     kable_styling(font_size = 10)
} 

if( knitr::is_html_output() ) {
  out <- kable(StressTab,
               format = "html",
               booktabs = TRUE,
               longtable = FALSE,
               align = "r",
               caption = "The surgery-stress data") %>%
    column_spec(1, bold = TRUE) %>%
     row_spec(1, bold = TRUE)
}
```





<!-- QUICK REVIEW ANSWERS -->
`r if (knitr::is_html_output()) '<!--'`
::: {.EOCanswerBox .EOCanswer data-latex="{iconmonstr-check-mark-14-240.png}"}
\textbf{Answers to \textit{Quick Revision} questions:}
**1.** False.
**2.** True.
**3.** $2.23$.
**4.** Very small.
:::
`r if (knitr::is_html_output()) '-->'`


