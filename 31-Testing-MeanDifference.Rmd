
# Tests for the mean difference (paired data) {#TestPairedMeans}


<!-- Introductions; easier to separate by format -->
```{r, child = if (knitr::is_html_output()) {'./introductions/31-Testing-MeanDifference-HTML.Rmd'} else {'./introductions/31-Testing-MeanDifference-LaTeX.Rmd'}}
```





```{r echo=FALSE}
insulate <- read.csv("./Data/InsulationBeforeAfter.csv")

colnames(insulate) <- c("Before", "After")
insulate$Diff <- insulate$Before - insulate$After

mn.I <- mean(insulate$Diff)
sd.I <- sd(insulate$Diff)
n.I <- length(insulate$Diff)
se.I <- sd.I / sqrt(n.I)
```


## Introduction: Insulation {#Chap29-Intro}


<div style="float:right; width: 222x; border: 1px; padding:10px">
<img src="Illustrations/pexels-taryn-elliott-4231477.jpg" width="200px"/>
</div>


`r if (knitr::is_html_output()) '<!--'`
\begin{wrapfigure}[7]{R}{.20\textwidth}
  \begin{center}
    \includegraphics[width=.15\textwidth]{Illustrations/pexels-taryn-elliott-4231477.jpg}
  \end{center}
\end{wrapfigure}
`r if (knitr::is_html_output()) '-->'`


The Electricity Council in Bristol wanted to determine if a certain type of wall-cavity insulation reduced energy consumption in winter, on average [@data:OpenUni:insulationBA].
Their RQ was:

> Is there a *mean saving* in energy consumption due to adding insulation?

The data collected are shown in
`r if( knitr::is_latex_output() ) {
    'Table \\@ref(tab:DataInsulationTest).'
} else {
    'the table below.'
}`
These data were used in Sect. \@ref(PairedCI), where a CI was constructed for the mean energy saving.

For these data, finding the *difference* in energy consumption for each house seems sensible.
The data are *paired* (Sect. \@ref(PairedInsulation)): the same unit of analysis is measured twice on the same variable (*before* and *after*), and the *mean* change is of interest.
That is, the comparison is [within individuals](#Comparison), and *not* between different groups of individuals.

Pairing the values for each house makes sense; hence finding the *difference* in energy consumption at each house makes sense.
The parameter is $\mu_d$, the population mean *saving* in energy consumption.


::: {.tipBox .tip data-latex="{iconmonstr-info-6-240.png}"}
Making clear *how* the differences are computed is important
\smallskip

Here, the differences could be computed as the  *Before* minus *After* (the energy consumption *saving*), or the *After* minus *Before* (the energy consumption *increase*).
Either is fine, as long as you are consistent throughout.
The meaning of any conclusions will be the same.
\smallskip

In this case, discussing energy *savings* seems most natural, so we compute the differences as *Before* minus *After*.
:::


```{r DataInsulationTest, echo=FALSE}
insulate <- read.csv("./Data/InsulationBeforeAfter.csv")

insulate$Diff <- insulate$Before - insulate$After

if( knitr::is_latex_output() ) {
  kable( insulate,
         format = "latex",
         booktabs = TRUE,
         col.names = c("Before", 
                       "After", 
                       "Energy savings"),
         caption = "The house insulation data: Energy consumption before and after adding insulation, and the energy saving (all in MWh)") %>%
	row_spec(0, bold = TRUE) %>%
    kable_styling(font_size = 10)
}
if( knitr::is_html_output(exclude = "epub") ) {
  DT::datatable( round(insulate, 1),
                 fillContainer = FALSE, # Make more room, so we don't just have ten values
                 #filter="top", 
                 #selection="multiple", 
                 #escape=FALSE,
                 options = list(searching = FALSE), # Remove searching: See: https://stackoverflow.com/questions/35624413/remove-search-option-but-leave-search-columns-option
                 caption = "The house insulation data: Energy consumption before and after adding insulation, and the energy saving (all in MWh)")
}
if( knitr::is_html_output() & knitr::pandoc_to("epub")) {
  kable( insulate,
         format = "html",
         booktabs = TRUE,
         col.names = c("Before", 
                       "After", 
                       "Energy savings"),
         caption = "The house insulation data: Energy consumption before and after adding insulation, and the energy saving (all in MWh)") %>%
	row_spec(0, bold = TRUE)
}
```


## Hypotheses and notation: Mean differences

The RQ asks if the mean energy saving *in the population* is zero or not.
The *parameter* is the *population mean difference*. 
To make things clear, notation is needed (recapping Sect. \@ref(PairedNotationCI)):

* $\mu_d$: The *population* mean *difference*.
* $\bar{d}$: The *sample* mean *difference*.
* $s_d$: The sample standard deviation of the *differences*.
* $n$: The number of *differences*.
* $\text{s.e.}(\bar{d})$: The standard error of the mean *differences*, 
  where $\displaystyle \text{s.e.}(\bar{d}) = \frac{s_d}{\sqrt{n}}$.

The hypotheses, therefore, can be written in terms of the parameter $\mu_d$.
The *null* hypothesis is 'there is *no change* in the energy consumption, in the population':

* $H_0$: $\mu_d = 0$.

As noted in Sect. \@ref(AboutHypotheses), the null hypothesis states that there is 'no difference, no change, no relationship', as measured by a parameter value.
This hypothesis, the initial **assumption**, postulates that the mean difference may not be zero in the *sample* due to sampling variation.

Since the RQ asks specifically if the insulation *saves* energy, the alternative hypothesis will be a [*one-tailed* hypothesis](#AboutHypotheses):

* $H_1$: $\mu_d > 0$ (one-tailed).

This hypothesis says that the mean energy saving in the population is *greater than* zero.
The alternative hypothesis is *one*-tailed because of the wording of the RQ.
Recall that the differences are defined as energy *savings*.


## Sampling distribution: Mean differences

Initially, assume that $\mu_d = 0$.
However, the *sample* mean energy saving will vary depending on which one of the many possible samples is randomly obtained, *even if* the mean saving in the population is zero: the sample mean energy saving has *sampling variation* and hence a *standard error*.
The *sampling distribution* of $\bar{d}$ can be described, which describes what values of the statistic might be **expected** in the sample if the $\mu_d = 0$.

Answering the RQ requires data.
The data should be summarised numerically (using your calculator or software, such as jamovi (Fig. \@ref(fig:InsulationTestNumericaljamovi)) or SPSS (Fig. \@ref(fig:InsulationTestNumericalSPSS))), and graphically (Fig. \@ref(fig:InsulationHistogram)).


```{r InsulationTestNumericaljamovi, echo=FALSE, fig.cap="jamovi output for the insulation data", fig.align="center", out.width="65%"}
knitr::include_graphics("jamovi/InsulationBeforeAfter/InsulationNumSummary.png")
```

```{r InsulationTestNumericalSPSS, echo=FALSE, fig.cap="SPSS output for the insulation data", fig.align="center", out.width="75%"}
knitr::include_graphics("SPSS/InsulationBeforeAfter/InsulationNumSummary.png")
```


The sample mean difference is $\bar{d} = 0.5400$... but this value of $\bar{d}$ will vary from sample to sample even if $\mu_d = 0$.
The amount of variation in $\bar{d}$ is quantified using the *standard error*.
More precisely, the possible values of the sample mean differences can, [under certain conditions](#ValiditySampleMeanDiffTest), described using 

* an approximate normal distribution; with
* a mean of $\mu_d = 0$ (taken from $H_0$); and
* a standard deviation (called the *standard error*) of $\text{s.e.}(\bar{d}) = s_d/\sqrt{n} = 0.3212$, where $s_d$ is the *standard deviation* of the differences.

This describes what can be **expected** from the possible values of $\bar{d}$ (Fig. \@ref(fig:EnergySamplingDist)), just through sampling variation (chance) if $\mu_d = 0$.


```{r EnergySamplingDist, echo=FALSE, fig.cap="The sampling distribution of sample means, if the energy saving in the population really was zero", fig.align="center", fig.width=10, fig.height=3, out.width='90%'}
par( mfrow = c(1, 2))

mn0 <- 0
mn <- 0.54
se <- 0.3212

plot.norm( 0, 
           se.I, 
           xlab.name = "Energy savings", 
           type = expression(bar(italic(d))),
           shade.hi.x = 5,
           cex.tickmarks = 1,
           shade.lo.x = 0.54,
           round.dec = 2)
arrows(1.68, 
       0.3, 
       1.68, 
       0.1,
       length = 0.2,
       angle = 15)
text(1.68, 
     0.3,
     pos = 3,
     expression(bar(italic(d)) == 0.54))


plot.norm( 0, 
           1, 
           xlab.name = "t-scores", 
           type = expression(italic(t)),
           shade.hi.z = Inf,
           shade.lo.z = 1.68,
           cex.tickmarks = 1,
           round.dec = 2)

arrows(1.68, 
       0.3, 
       1.68, 
       0.1,
       length = 0.2,
       angle = 15)
text(1.68, 
     0.3,
     pos = 3,
     expression( italic(t) == 1.68))
```


## The test statistic: Mean differences

The sample mean difference can be located on the sampling distribution (Fig. \@ref(fig:EnergySamplingDist)) by computing the $t$-score:

\[
	t = \frac{0.54 - 0}{0.3212} = 1.681,
\]
following the ideas in Equation \@ref(eq:tscore).
Software computes the $t$-score too (jamovi: Fig. \@ref(fig:InsulationTest2jamovi); SPSS: Fig. \@ref(fig:InsulationTest2SPSS)).
The $t$-score locates the **observed** sample statistic on the sampling distribution.


## $P$-values: Mean differences

A $P$-value determines if the sample data are consistent with the assumption (Table \@ref(tab:PvaluesInterpretation)).
Since $t = 1.681$, the *one-tailed* $P$-value is between 2.5% and 16% based on the [68--95--99.7 rule](#def:EmpiricalRule).
This is a wide, and inconclusive, interval for the $P$-value. 

Software gives a more precise $P$-value (jamovi: Fig. \@ref(fig:InsulationTest2jamovi); SPSS: Fig. \@ref(fig:InsulationTest2SPSS)): the *two-tailed* $P$-value is $0.127$, so the *one-tailed* $P$-value is $0.127/2 = 0.0635$.


```{r InsulationTest2jamovi, echo=FALSE, fig.cap="jamovi output for the insulation data", fig.align="center", out.width="80%"}
knitr::include_graphics("jamovi/InsulationBeforeAfter/InsulationBeforeAfterPairedTOutput.png")
```


```{r InsulationTest2SPSS, echo=FALSE, fig.cap="SPSS output for the insulation data", fig.align="center", out.width="85%"}
knitr::include_graphics("SPSS/InsulationBeforeAfter/InsulationBeforeAfterPairedTOutput.png")
```

::: {.importantBox .important data-latex="{iconmonstr-warning-8-240.png}"}
The software clarifies *how* the differences have been computed:

* **jamovi**: 
  At the left of the output (Fig. \@ref(fig:InsulationTest2jamovi)), the order implies the differences are found as `Before minus After`.

* **SPSS**: 
  At the left of the output (Fig. \@ref(fig:InsulationTest2SPSS)), the difference is described as `Before - After`.
:::

`r if (knitr::is_latex_output()) '<!--'`
::: {.thinkBox .think data-latex="{iconmonstr-light-bulb-2-240.png}"}
<iframe src="https://learningapps.org/watch?v=pj3pt56fk22" style="border:0px;width:100%;height:500px" allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true"></iframe>
:::
`r if (knitr::is_latex_output()) '-->'`


## Conclusions: Mean differences

The *one-tailed* $P$-value is $0.0635$, suggesting only slight evidence (see Table \@ref(tab:PvaluesInterpretation)) supporting $H_1$.
To write a conclusion, an *answer to the RQ* is needed, plus *evidence* leading to that conclusion; and some *summary statistics*, including a CI (indicating the precision of the statistic):

> Slight evidence exists in the sample (paired $t = 1.68$; one-tailed $P = 0.0635$) of a mean energy saving in the population (mean saving: 0.54 MWh; $n = 10$; 95% CI from $-0.19$ to $1.27$ MWh) after adding the insulation.

The wording implies the direction of the differences (by talking of 'savings').

Statistically validity should be checked, which was done in Sect. \@ref(ValidityPaired), but the validity conditions are given again in the next section, for completeness.


::: {.example #HTMeanDiffCOVID name="COVID lockdown"}
A study of $n = 213$ Spanish health students [@romero2020physical] measured (among other things) the number of minutes of vigorous physical activity (PA) performed by students *before* and *during* the COVID-19 lockdown (from March to April 2020 in Spain).
These numerical summary of the data are shown in Example \@ref(exm:CIMeanDiffCOVID), so are not repeated here.
We define the *differences* as the number of minutes of vigorous PA *before* the COVID lockdown, minus the number of minutes of vigorous PA *during* the COVID lockdown.
A difference is computed for each participant, so the data are *paired*.

Using this definition, a *positive* difference means the *Before* value is higher; hence, the differences tell us how much longer the student spent doing vigorous PA *before* the COVID lockdown.
Similarly, a *negative * value means that the *During* value is higher.
The RQ is

> For Spanish health students, is there a mean change in the amount of vigorous PA during and before the COVID lockdown? 
  
In this situation, the *parameter* of interest is the population mean difference $\mu_d$, the mean amount that students spent in vigorous PA *before* the lockdown compared to *during* the lockdown.
The hypotheses are:
  
\[
   \text{$H_0$:} \mu_d = 0\quad\text{and}\quad \text{$H_1$:} \mu_d \ne 0 \text{(i.e., two-tailed)}
\]
The mean *difference* is $\bar{d} = -2.68$ minutes, with a standard deviation of $s_d = 51.30$ minutes.
However, we know that the sample mean difference could vary from sample to sample, so has a standard error:
$\text{s.e.}(\bar{d}) = s_d\div \sqrt{n} = {51.30}\div{\sqrt{213}} = 3.515018$.
The test statistic is

\[
  t = \frac{\bar{d} - \mu_d}{\text{s.e.}(\bar{d})} = \frac{-2.68 - 0}{3.515018} = -0.76.
\]

This is a very small value, so (using the 68--95--99.7 rule) the $P$-value will be very large: a sample mean difference of -2.68 minutes could easily have happened by chance even if the population mean difference was zero.

We write:

> There is no evidence (paired $t = -0.76$, $P > 0.10$) of a mean change in the amount of vigorous PA *before* and *during* lockdown (sample mean 2.68 minutes greater *during* lockdown; standard deviation: 51.30 minutes; approximate 95% CI: $-9.71$ to $7.03$).
:::


## Statistical validity conditions: Mean differences {#ValiditySampleMeanDiffTest}

As with any inferential procedure, these results apply [under certain conditions](#exm:StatisticalValidityAnalogy).
For a hypothesis test for the mean of paired data, these conditions are the same as for the CI for the mean difference for paired data (Sect. \@ref(ValidityPaired)), and similar to those for one sample mean.

The test above is statistically valid if *one* of these conditions is true:

1. The sample size of differences is at least 25; **or**
1. The sample size of differences is smaller than 25, **and** the *population* of *differences* has an approximate normal distribution.

The sample size of 25 is a rough figure here, and some books give other values (such as 30).
This condition ensures that the *distribution of the sample means has an approximate normal distribution* so that we can use the [68--95--99.7 rule](#def:EmpiricalRule).

Provided the sample size is larger than about 25, this will be approximately true *even if* the distribution of the individuals in the population does not have a normal distribution.
That is, when $n > 25$ the sample means generally have an approximate normal distribution, even if the data themselves don't have a normal distribution.


::: {.example #StatisticalValidityInsulationHT name="Statistical validity"}
For the insulation data used above, the sample size is small, so the test will be statistically valid if the differences in the *population* follow a normal distribution.
We don't know if they do, though the sample data (Fig. \@ref(fig:InsulationHistogram)) don't identify any obvious doubts. 
So the test is possibly statistically valid, but we can't be sure.
:::


::: {.example #StatisticalValidityHTMeanDiffCOVID name="COVID lockdown"}
In Example \@ref(exm:HTMeanDiffCOVID) concerning COVID lockdowns, the sample size was 213 Spanish health students.
Since the sample size is much larger than 25, the test is statistically valid.
:::


## Example: Endangered species {#EndangeredHT}

A study of endangered species [@harnish2020attitudes] examined 

> ...whether perceived physical attractiveness of a species impacted participants' attitudes toward supporting and protecting the species...
>
> --- @harnish2020attitudes, p. 1703

To do so, 210 undergraduate students were surveyed about 14 animals on various aspects of supporting and protecting them.
Part of the data are summarised below, for two animals when asked about 'support to protect the animal from illicit trade'.
*Larger* values means *greater* support for protecting the animal from illicit trade.


| Species                            | Mean score      | Standard deviation
|-----------------------------------:+:---------------:+:-------------------:
| Bay Checkerspot Butterfly          | 3.10            | 1.06
| Valley Elderberry Longhorn Beetle  | 2.33            | 1.13
| **Difference**                     | 0.77            | 1.07

(Notice that the standard deviation of the difference is **not** the difference between the two given values of the standard deviation.)

The *difference* is defined as each student's score for the butterfly (deemed more attractive) *minus* their score for the beetle (deemed less attractive).
A positive value therefore means more support (on average) for the butterfly.
The RQ is whether there is a mean difference between support for each animal, so the parameter is $\mu_d$, the population mean difference.

The researchers wished to test if

> ...animals perceived as more physically attractive (i.e., the butterfly) compared to those which are perceived as less physically attractive (i.e., the beetle) will receive relatively more support to prevent the species from illicit trade
>
> --- @harnish2020attitudes, p. 1704

Given how the difference are defined, the hypotheses are:

\[
   H_0: \mu_d = 0\quad\text{and}\quad H_1: \mu_d > 0 \text{(i.e., one-tailed, based on the researchers' purpose)}
\]
The mean difference is $\bar{d} = 0.77$ and $s_d = 1.07$.
The value of $\bar{d}$ will vary from sample to sample, so has a standard error:

\[
   \text{s.e.}(\bar{d}) = \frac{s_d}{\sqrt{n}} = \frac{1.07}{\sqrt{210}} = 0.073837.
\]
The value of the test statistic is

\[
   t = \frac{\bar{d} - \mu_d}{\text{s.e.}(\bar{d})} = \frac{0.77 - 0}{0.073837} = 10.43,
\]
which is a *very* large value. 
Hence, the $P$-value will be very small, certainly less than $0.05$.
Since the sample size is much larger than 25, the test will be statistically valid.

We write:

> There is very strong evidence ($t = 10.43$; one-tailed $P<0.001$) that the mean difference in support for protecting the Bay Checkerspot Butterfly from illicit trade is greater than support for protecting the Valley Elderberry Longhorn Beetle from illict trade (mean difference: 0.77; standard deviation: 1.07; 95% CI for the difference: 0.62 to 0.92).


## Example: Blood pressure {#Diabetes}


```{r echo=FALSE, cache=FALSE}
diab2 <- read.csv("./Data/Diabetes.csv")
diab2$Diff <- diab2$bp.1d - diab2$bp.2d

n.D.diff <- length( diab2$Diff ) - sum( is.na(diab2$Diff) )
se.D.diff <- sd(diab2$Diff, na.rm = TRUE) / sqrt(n.D.diff)

### REORDER
diab.names <- names(diab2)
diab <- diab2[ c(which( diab.names %in% c("id", "bp.1d", "bp.2d")) , 
                which( !(diab.names %in% c("id", "bp.1d", "bp.2d")) ) )]

```


<div style="float:right; width: 222x; border: 1px; padding:10px">
<img src="Illustrations/hush-naidoo-pA0uoltkwao-unsplash.jpg" width="200px"/>
</div>


`r if (knitr::is_html_output()) '<!--'`
\begin{wrapfigure}[5]{R}{.25\textwidth}
  \begin{center}
    \includegraphics[width=.20\textwidth]{Illustrations/hush-naidoo-pA0uoltkwao-unsplash.jpg}
  \end{center}
\end{wrapfigure}
`r if (knitr::is_html_output()) '-->'`

A US study [@data:Willems1997:CHD; @data:Schorling1997:smoking] was conducted to determine how CHD risk factors were assessed among parts of the population.
Subjects were required to report to the clinic on multiple occasions.

One RQ of interest is:

> Is there a mean difference in blood pressure measurements between the first and second visits? 

The parameter is $\mu_d$, the population mean *reduction* in blood pressure.
Each person has a *pair* of diastolic blood pressure (DBP) measurements: One each from their first and second visits.
The data
`r if (knitr::is_latex_output()) {
   '(Table \\@ref(tab:DiabetesDataTable))'
} else {
   'shown below,'
}`
are from 141 people.
These data were shown in Sect. \@ref(BloodPressure).
The differences could be computed in one of two ways:   

* The observation from the first visit, minus the observation from the second visit: the *reduction* in BP; or
* The observation from the second visit, minus the observation from the first visit: the *increase* in BP.

Either way is fine, as long as the order remains consistent, and the direction is made clear.
Here, the observations from the *first* visit minus the observation from the *second* visit will be used, so that the differences represent the *decrease* in BP
from the first to second measurement.


```{r DiabetesDataTable2, echo=FALSE}
DiffExists <- complete.cases(diab[, c("bp.1d", "bp.2d", "Diff")])

DiffExists <- complete.cases(diab[, c("bp.1d", "bp.2d", "Diff")])

if( knitr::is_latex_output() ) {
  kable( head( diab[DiffExists, 
                    c("bp.1d", "bp.2d", "Diff")], 
               10),
         format = "latex",
         booktabs = TRUE,
         longtable = FALSE,
         row.names = FALSE,
         col.names = c("DBP: First visit", "DBP: Second visit", "Reduction in DBP"),
         caption = "The first ten observations (from the $n=141$ available) from the diabetes study for people with both measurements: Diastolic blood pressure (DBP) for the first and second visits, and the decrease in DBP, all in mm Hg") %>%
  	row_spec(0, bold = TRUE) %>%
    kable_styling(font_size = 10)
}
if( knitr::is_html_output(exclude = "epub") ) {
  DT::datatable( diab[DiffExists, 
                      c("bp.1d", "bp.2d", "Diff")],
                 fillContainer = FALSE, # Make more room, so we don't just have ten values
                 #filter="top", 
                 #selection="multiple", 
                 #escape=FALSE,
                 colnames = c("First", 
                              "Second", 
                              "Differences"),
                 options = list(searching = FALSE), # Remove searching: See: https://stackoverflow.com/questions/35624413/remove-search-option-but-leave-search-columns-option
                 caption = "The observations from the diabetes study for people with both measurements: Diastolic blood pressure (DBP) for the first and second visits, and the decrease in DBP, all in mm Hg")
}
if( knitr::is_html_output() & knitr::pandoc_to("epub")) {
  kable( head( diab[DiffExists, 
                    c("bp.1d", "bp.2d", "Diff")], 
               10),
         format = "html",
         booktabs = TRUE,
         longtable = FALSE,
         row.names = FALSE,
         col.names = c("DBP: First visit", "DBP: Second visit", "Reduction in DBP"),
         caption = "The first ten observations (from the $n=141$ available) from the diabetes study for people with both measurements: Diastolic blood pressure (DBP) for the first and second visits, and the decrease in DBP, all in mm Hg")
}
```

The appropriate graphical summary is a histogram of differences (Fig. \@ref(fig:DiabetesHIST)); the numerical summary is shown in  Table \@ref(tab:DiabSummTable2).
Notice that having the information about the differences is essential, as the RQ is about the differences.


```{r DiabSummTable2,echo=FALSE}
Diab.Table <- array( dim = c(3, 4))

n.diab <- function(x){
  length(x) - sum( is.na(x))
}

se.diab <- function(x) {
  sd(x, na.rm = TRUE) / sqrt(n.diab(x) )
}

Diab.Table[1, 1] <- mean(diab$bp.1d[DiffExists], na.rm = TRUE)
Diab.Table[2, 1] <- mean(diab$bp.2d[DiffExists], na.rm = TRUE)
Diab.Table[3, 1] <- mean(diab$Diff[DiffExists], na.rm = TRUE)

Diab.Table[1, 2] <- sd(diab$bp.1d[DiffExists], na.rm = TRUE)
Diab.Table[2, 2] <- sd(diab$bp.2d[DiffExists], na.rm = TRUE)
Diab.Table[3, 2] <- sd(diab$Diff[DiffExists], na.rm = TRUE)

Diab.Table[1, 3] <- se.diab(diab$bp.1d[DiffExists])
Diab.Table[2, 3] <- se.diab(diab$bp.2d[DiffExists])
Diab.Table[3, 3] <- se.diab(diab$Diff[DiffExists])

Diab.Table[1, 4] <- n.diab(diab$bp.1d[DiffExists])
Diab.Table[2, 4] <- n.diab(diab$bp.2d[DiffExists])
Diab.Table[3, 4] <- n.diab(diab$Diff[DiffExists])

rownames(Diab.Table) <- c("DBP: First visit", 
                          "DBP: Second visit", 
                          "Decrease in DBP")

if( knitr::is_latex_output() ) {
kable(Diab.Table,
      format = "latex",
      booktabs = TRUE,
      longtable = FALSE,
      col.names = c("Mean", 
                    "Standard deviation", 
                    "Standard error", 
                    "Sample size"),
      digits = c(2, 3, 3, 0),
      caption = "The numerical summary for the diabetes data (in mm Hg). The differences are the second visit value minus the first visit value: the decreases in diastolic blood pressure from the first to second visit") %>%
    row_spec(0, bold = TRUE) %>%
    kable_styling(font_size = 10)
}
if( knitr::is_html_output() ) {
kable(Diab.Table,
      format = "html",
      booktabs = TRUE,
      longtable = FALSE,
      col.names = c("Mean", 
                    "Standard deviation", 
                    "Standard error", 
                    "Sample size"),
      digits = c(2, 3, 3, 0),
      caption = "The numerical summary for the diabetes data (in mm Hg). The differences are the second visit value minus the first visit value: the decreases in diastolic blood pressure from the first to second visit")
}
```


As always (Sect. \@ref(AboutHypotheses)), the null hypothesis is the 'no difference, no change, no relationship' position, proposing that the mean difference in the population is non-zero due to sampling variation:

* $H_0$: $\mu_d = 0$ (differences: $\text{first} - \text{second}$); \quad\text{and}\quad $H_1$: $\mu_d \ne 0$.

The alternative hypothesis is *two-tailed* because of the wording of the RQ.
As usual, **assume** that $H_0$ is true, and then the evidence is evaluated to determine if it contradicts this assertion.

The sampling distribution describes how the sample mean difference is **expected**  to vary from sample to sample due to sampling variation, when $\mu_d = 0$.
Under certain circumstances, the sample mean differences are likely to vary with a normal distribution, with a mean of 0 (from $H_0$) and a standard deviation of $\text{s.e.}(\bar{d}) = 0.676$.

The relative value of the **observed** sample statistic is found by computing a $t$-score, using software (jamovi: Fig. \@ref(fig:DiabetesTestjamovi); SPSS: Fig. \@ref(fig:DiabetesTestSPSS)), or manually (Eq. \@ref(eq:tscore), using the information in Table \@ref(tab:DiabSummTable2)):

\begin{align*}
  t 
  &= \frac{\text{sample statistic} - \text{assumed population parameter}}
         {\text{standard error of the statistic}}\\
  &= \frac{1.950 - 0}{0.676} = 2.885.
\end{align*}
Either way, the $t$-score is the same.


```{r DiabetesTestjamovi, echo=FALSE, fig.cap="jamovi output for the diabetes data", fig.align="center",  out.width="90%"}
knitr::include_graphics("jamovi/Diabetes/Diabetes-Test-All.png")
```


```{r DiabetesTestSPSS, echo=FALSE, fig.cap="SPSS output for the diabetes data", fig.align="center", out.width="80%"}
knitr::include_graphics("SPSS/Diabetes/Diabetes-Test-All.png")
```


A $P$-value is then needed to decide if the sample is **consistent** with the assumption.
Using the  [68--95--99.7 rule](#def:EmpiricalRule), the approximate two-tailed $P$-value is much smaller than 0.05.
Alternatively, the software output (Fig. \@ref(fig:DiabetesTestjamovi); Fig. \@ref(fig:DiabetesTestSPSS)) reports the two-tailed $P$-value as $P = 0.005$.
We conclude:

> Strong evidence exists in the sample (paired $t = 2.855$; two-tailed $P = 0.005$) of a population mean difference between the first and second DBP readings (mean difference $1.95$ mm Hg higher for first reading; 95% CI\ from $0.61$ to $3.3$ mm Hg; $n = 141$).

Since $n > 25$, the results are statistically valid.

::: {.importantBox .important data-latex="{iconmonstr-warning-8-240.png}"}
Just saying 'there is evidence of a difference' is insufficient.
You must state *which* measurement is, on average, higher (that is, what the differences *mean*).
:::


<iframe src="https://learningapps.org/watch?v=pj3pt56fk22" style="border:0px;width:100%;height:500px" allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true"></iframe>



## Summary {#Chap29-Summary}

Consider testing a hypothesis about a population mean difference $\mu_d$, based on the value of the sample mean difference $\bar{d}$.
Under certain statistical validity conditions, the sample mean difference varies with an approximate normal distribution centered around the hypothesised value of $\mu_d$, with a standard deviation of

\[
   \text{s.e.}(\bar{d}) = \frac{s_d}{\sqrt{n}}.
\]
This distribution describes what values of the sample mean difference could be **expected** if the value of $\mu_d$ in the null hypothesis was true.
The *test statistic* is

\[
   t = \frac{ \bar{d} - \mu_d}{\text{s.e.}(\bar{d})},
\]
where $\mu_d$ is the hypothesised value in the null hypothesis.
The $t$-score describes what value of $\bar{d}$ was **observed** in the sample, relative to what was expected.
The $t$-value is like a $z$-score, so an approximate **$P$-value** can be estimated using the [68--95--99.7 rule](#def:EmpiricalRule), or is found using software.
The $P$-values helps determine if the sample evidence is consistent with the assumption, or contradicts the assumption.


`r if (knitr::is_html_output()){
  'The following short video may help explain some of these concepts:'
}`



<div style="text-align:center;">
```{r, echo=FALSE}
htmltools::tags$video(src = "./videos/PairedTTest.mp4", 
                      width = "550", 
                      controls = "controls", 
                      loop = "loop", 
                      style = "padding:5px; border: 2px solid gray;")
```
</div>


## Quick review questions {#Chap29-QuickReview}

A study [@bacho2019effects] compared joint pain in stroke patients before and after a supervised exercise treatment.
Participants ($n = 34$) were assessed *before* and *after* treatment.

The mean *change* in joint pain after 13 weeks was 1.27 (with a standard error of 0.57) using a standardised tool.

1. True or false? Only 'before and after' studies can be paired.  
`r if( knitr::is_html_output(exclude = "epub") ) { torf( answer=FALSE )}`

1. True or false? The null hypothesis is about the population mean *difference*.  
`r if( knitr::is_html_output(exclude = "epub") ) { torf( answer=TRUE )}`

1. The value of the test statistic (to two decimal places) is  
`r if( knitr::is_html_output(exclude = "epub") ) { fitb( answer=2.23, num=TRUE, tol=0.01 )} else {"________________"}`

1. The two-tailed $P$-value will be  
`r if( knitr::is_html_output(exclude = "epub") ) {mcq( 
	c(answer = "Very small",
		"Small",
    "About 0.05",
		"Large",
		"Very large")
)} else {"________________"}`



`r if (!knitr::is_html_output()) '<!--'`
::: {.progressBox .progress}
**Progress:**  `r webexercises::total_correct()`
:::
`r if (!knitr::is_html_output()) '-->'`



## Exercises {#TestPairedMeansExercises}

Selected answers are available in Sect. \@ref(TestPairedMeansAnswer).

::: {.exercise #TestPairedMeansTasteOfBrocolli}
People often struggle to eat the recommended intake of vegetables.
In one study exploring ways to increase vegetable intake in teens [@data:Fritts2018:Vegetables], teens rated the taste of raw broccoli, and raw broccoli served with a specially-made dip.
(These data were also seen in Exercise \@ref(exr:PairedCIExercisesBrocolli).)

Each teen ($n = 101$) had a *pair* of measurements: the taste rating of the broccoli *with* and *without* dip.
Taste was assessed using a '100 mm visual analog scale', where a higher score means a better taste.
In summary:

* For raw broccoli, the mean taste rating was $56.0$ (with a standard deviation of $26.6$);
 <!-- %  (SDs); so if $n = 101$ we'd get SE: 2.647 -->
* For raw broccoli served with dip, the mean taste rating was $61.2$ (with a standard deviation of $28.7$).

Because the data are paired, the *differences* are the best way to describe the data.
The mean difference in the ratings was $5.2$, with standard error of $3.06$. 
<!-- (working backwards from the $t$-score). Looks like $n=101$. -->

Perform a hypothesis test to see if the use of dip increases the mean taste rating.
:::


```{r echo=FALSE}
blood <- read.csv("./Data/Captopril.csv")

blood$Differences <- blood$Before - blood$After

  
bloodS <- subset(blood, BP=="S")
bloodS <- bloodS[, c("Before", 
                     "After", 
                     "Differences")]

bloodS2 <- cbind( "Before" = bloodS$Before[1:8], 
                  "After" = bloodS$After[1:8],
                  "Before" = c(bloodS$Before[9:15], NA), 
                  "After" = c(bloodS$After[9:15], NA) )
```


::: {.exercise #TestPairedMeansCaptopril}
In a study of hypertension [@data:hand:handbook; @data:macgregor:essential], patients were given a drug (Captopril) and their systolic blood pressure measured immediately before and two hours after being given the drug (data shown).

The aim is to see if there is evidence of a *reduction* in blood pressure after taking Captopril.
(This study was also seen in Exercise \@ref(exr:PairedCIExercisesCaptopril).)

Using these data and the software output (jamovi: Fig. \@ref(fig:CaptoriljamoviHT); SPSS: Fig. \@ref(fig:CaptorilSPSSHT)):

1. Explain why it is probably more sensible to compute differences as the *Before* minus the *After* measurements. 
   What do the differences *mean* when computed this way?
1. Compute the differences.
1. Construct a suitable graph for the differences.
1. Write down the hypotheses.
1. Write down the $t$-score.
1. Write down the $P$-value.
1. Write a conclusion.
:::

    

```{r HTCaptoprilData, echo=FALSE}
if( knitr::is_latex_output() ) {
  kable( bloodS2,
         format = "latex",
         booktabs = TRUE,
         longtable = FALSE,
         caption = "The Captopril data: before after after systolic blood pressures (in mm Hg)") %>%
   add_header_above(header = c("  " = 2, "  " = 2), 
                    bold = TRUE, 
		    align = "c") %>%
    kable_styling(font_size = 10)
    
}
if( knitr::is_html_output() ) {
  out <- kable( bloodS2,
                format = "html",
                booktabs = TRUE,
                longtable = FALSE,
                caption = "The Captopril data: before after after systolic blood pressures (in mm Hg)")
  if ( knitr::is_html_output(excludes = "epub")) {
    add_header_above(out, 
                     header=c("  " = 2, "  " = 2), 
		     bold = TRUE, 
		     align = "c")
  } else {
    out
  }
   
}
```


```{r CaptoriljamoviHT, echo=FALSE, fig.cap="jamovi output for the Captoril data", fig.align="center", out.width="80%"}
knitr::include_graphics("jamovi/CaptoprilAll/CaptoprilAll-PairedTOutput.png")
```

```{r CaptorilSPSSHT, echo=FALSE, fig.cap="SPSS output for the Captoril data", fig.align="center",     out.width="80%"}
knitr::include_graphics("SPSS/CaptoprilAll/CaptoprilAll-PairedTOutput.png")
```


::: {.exercise #TestPairedMeansSmokingAndExercise}
A study [@data:Allen2018:Smoking] examined the effect of exercise on smoking.
Men and women were assessed on a range of measures, including the 'intention to smoke'.
(This study was also seen in Exercise \@ref(exr:PairedCIExercisesSmokeExercise).)

'Intention to smoke', and other measures, were assessed both before and after exercise for each subject, using the 10-item quantitative [*Questionnaire of Smoking Urges -- Brief*](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2527734/) scale [@cox2001evaluation], and the quantitative [*Minnesota Nicotine Withdrawal Scale*](http://www.med.uvm.edu/behaviorandhealth/research/minnesota-tobacco-withdrawal-scale) [@shiffman2004recommendation].

Smokers (defined as people smoking at least five cigarettes per day) aged 18 to 40 were enrolled for the study.
For the 23 women in the study, the mean intention to smoke after exercise *reduced* by 0.66 (with a standard error of 0.37).

Perform a hypothesis test to determine if there is evidence of a population mean reduction in intention to smoke for women after exercising.
:::


```{r echo=FALSE}
FR <- read.csv("./Data/Ferritin.csv")
```


::: {.exercise #TestPairedMeansFerritin}
In a study [@cressie1984use] conducted at the Adelaide Children's Hospital:

> ...a group of beta thalassemia patients [...] were treated by a continuous infusion of desferrioxamine, in order to *reduce* their ferritin content...
>
> --- @cressie1984use, p. 107; emphasis added

Using the data (shown below), conduct a hypothesis test to determine if there is evidence that the treatment reduces the ferritin content, as intended.
:::

```{r FerritinTable, echo=FALSE}
if( knitr::is_latex_output() ) {
  kable( head(FR, 10),
        format = "latex",
        longtable = FALSE,
        caption = "The ferritin content (in $\\mu$g/L) for 20 thalassemia patients at the Adelaide Children's Hospital (first ten observations)",
        booktabs = TRUE) %>%
    kable_styling(font_size = 10)
}
if( knitr::is_html_output(exclude = "epub") ) {
   DT::datatable(FR,
                 fillContainer = FALSE, # Make more room, so we don't just have ten values
                 filter = "none",
                 options = list(searching = FALSE), # Remove searching: See: https://stackoverflow.com/questions/35624413/remove-search-option-but-leave-search-columns-option
                 caption = "The ferritin content (in micrograms per L) for 20 thalassemia patients at the Adelaide Children's Hospital")
}
if( knitr::is_html_output() & knitr::pandoc_to("epub")) {
  kable( head(FR, 10),
        format = "html",
        longtable = FALSE,
        caption = "The ferritin content (in $\\mu$g/L) for 20 thalassemia patients at the Adelaide Children's Hospital (first ten observations)",
        booktabs = TRUE)
}
```

::: {.exercise #DecelerationHT}
In an attempt to reduce vehicle speeds on freeway exit ramps, a Chinese study tried using additional signage [@ma2019impacts].
At one site studied (Ningxuan Freeway), speeds were recorded at various points on the freeway exit for vehicles *before* the extra signage was added, and then *after* the extra signage was added.

NEEDW REWORDING! SOUNDS LIKE TWO-SAMPLE!!

From this data, the *deceleration* of each vehicle was determined (data below) as the vehicle left the 120 km/h speed zone and approached the 80 km/hr speed zone. 
Use the data, and the summary in Table \@ref(tab:SignageSummaryDecHT), to test the RQ:

> At this freeway exit, is the mean vehicle deceleration the same before extra signage is added and after extra signage is added?
:::


```{r SignageDecHT, echo=FALSE}
Decel <- read.csv("./Data/Deceleration.csv")

Decel$When <- factor(Decel$When,
                     levels = c("Before", 
                                "After"),
                     ordered = TRUE)

if( knitr::is_latex_output() ) {
  
  kable( Decel[1:10,],
         format = "latex",
         longtable = FALSE,
         booktabs = TRUE,
         align = c("c", "c", "c"),
         caption = "Vehicle deceleration before and after adding extra signage (negative values mean the vehicle has accelerated). Only the first 10 observations are shown.") %>%
    kable_styling(font_size = 10)
}

if( knitr::is_html_output(exclude = "epub") ) {
  
   out2 <-  DT::datatable( Decel,
                 fillContainer = FALSE, # Make more room, so we don't just have ten values
                 colnames = c("When measured", "Deceleration (m/s-squared)"),
                 options = list(searching = FALSE), # Remove searching: See: https://stackoverflow.com/questions/35624413/remove-search-option-but-leave-search-columns-option
                 caption = "The observations from the signage data (negative values mean the vehicle has accelerated)")

    out <- kable( Decel,
                format = "html",
                longtable = FALSE,
                booktabs = TRUE,
                align = c("c", "c"),
                caption = "Vehicle deceleration before and after adding extra signage (negative values mean the vehicle has accelerated)")
}
 if ( knitr::is_html_output() & knitr::pandoc_to("epub")) {
  kable( Decel[1:10,],
         format = "html",
         longtable = FALSE,
         booktabs = TRUE,
         align = c("c", "c", "c"),
         caption = "Vehicle deceleration before and after adding extra signage (negative values mean the vehicle has accelerated). Only the first 10 observations are shown.")
}
```


```{r SignageSummaryDecHT, echo=FALSE}
SignageSummaryDec <- array(dim = c(3, 4))
rownames(SignageSummaryDec) <- c("Before", 
                            "After",
                            "Change")
colnames(SignageSummaryDec) <- c("Mean",
                              "Std deviation",
                              "Std error",
                              "Sample size")

Speed.n <- tapply(Decel$Decel, 
                  list(Decel$When), 
                  "length") 
Speed.sd <- tapply(Decel$Decel, 
                   list(Decel$When), 
                   "sd") 

SignageSummaryDec[1:2, 1] <- round( tapply(Decel$Decel, 
                                        list(Decel$When), 
                                        "mean"),
                                 4)
SignageSummaryDec[1:2, 2] <- round( Speed.sd, 4)
SignageSummaryDec[1:2, 3] <- round( Speed.sd / sqrt(Speed.n), 5)
SignageSummaryDec[1:2, 4] <- Speed.n 

SignageSummaryDec[3, 1] <- SignageSummaryDec[1, 1] -  
                           SignageSummaryDec[2, 1] 

sdB <- round( SignageSummaryDec[1, 3], 4)
sdA <- round( SignageSummaryDec[2, 3], 4)
SignageSummaryDec[3, 3] <- round( sqrt( sdB^2/Speed.n[1] + 
                                     sdA^2/Speed.n[2] ), 
                               5)

SignageSummaryDec[3, 4] <- NA 
SignageSummaryDec[3, 2] <- NA
                          


if( knitr::is_latex_output() ) {
  kable(SignageSummaryDec,
        format = "latex",
        longtable = FALSE,
        booktabs = TRUE,
        align = c("r", "r", "r", "l"),
        col.names = c("Mean", 
                      "Std deviation", 
                      "Sample size", 
                      "Std error"),
        caption = "The signage data summary (in m/s-squared)"
  ) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(font_size = 10)
}
if( knitr::is_html_output() ) {
  out <- kable(SignageSummaryDec,
               format = "html",
               longtable = FALSE,
               booktabs = TRUE,
               align = c("r", "r", "r", "l"),
               col.names = c("Mean", 
                            "Std deviation", 
                            "Sample size", 
                            "Std error"),
    caption = "The signage data summary (in m/s-squared)"
  )
  if ( knitr::is_html_output(excludes = "epub")) {
    kable_styling(out, full_width = FALSE)
  } else {
    out
  }
}
```


::: {.exercise #StressSurgeryHT}
The concentration of beta-endorphins in the blood are a sign of stress.
In one study (@data:hand:handbook, Dataset 232; @hoaglin2011exploring), the beta-endorphin concentration was measured for 19 patients about to undergo surgery.
The RQ was:

> For patients approaching surgery, is there a mean increase in beta-endorphin concentrations?

Each patient had their beta-endorphin concentrations measured 12--14 hours before surgery, and also 10 minutes before surgery.
A numerical summary can be produced from jamovi output (Fig. \@ref(fig:StressDescriptivesjamovi)).


```{r StressDescriptivesjamovi, echo=FALSE, fig.cap="", fig.align="center", out.width='80%'}

ST <- read.csv("Data/stress.csv")

StressTab <- data.frame(
  "Means" = c( colMeans(ST),
               mean(ST$BeforeMins - ST$BeforeHours) ),
  "Std deviation" = c( apply(ST, 2, "sd"),
                       sd(ST$BeforeMins - ST$BeforeHours) ),
  "Std Error" = c( apply(ST, 2, function(x){sd(x)/sqrt(length(x))}),
                   sd(ST$BeforeMins - ST$BeforeHours)/sqrt(19) ),
  "Sample size" = c( apply(ST, 2, length),
                     length(ST$BeforeMins - ST$BeforeHours) )
)
rownames(StressTab) <- c("12--14 hours before surgery",
                         "10 minutes before surgery",
                         "Increase")
  
if( knitr::is_latex_output() ) {
  knitr::kable(StressTab,
               format = "latex",
               booktabs = TRUE,
               longtable = TRUE,
               caption = "The surgery-stress data",
               col.names = c("Sample mean",
                             "Std deviation",
                             "Std error",
                             "Sample size"),
               row.names = TRUE,
               digits = 2)%>%
     column_spec(1, bold = TRUE) %>%
     row_spec(0, bold = TRUE) %>%
     kable_styling(font_size = 10)
} 

if( knitr::is_html_output() ) {
  out <- kable(StressTab,
               format = "html",
               booktabs = TRUE,
               longtable = FALSE,
               align = "r",
               caption = "The surgery-stress data") %>%
    column_spec(1, bold = TRUE) %>%
     row_spec(1, bold = TRUE)
}
```

The hypotheses are:

\[
   H_0: \mu_D = 0;\quad\text{and}\quad H_1: \mu_D > 0
\]
provided we DEFINE...

The jamovi output in Fig. \@ref(fig:StressDescriptivesHTjamovi) can be used to test the hypotheses.

```{r StressDescriptivesHTjamovi, echo=FALSE, fig.cap="jamovi output for the surgery-stress data", fig.align="center", out.width='80%'}
knitr::include_graphics("jamovi/Stress/StressDescriptives.png")
```

Assuming the null hypothesis is true, the $t$-score is

\[
   t = \frac{\bar{d}- \mu_d}{\text{s.e.}(\bar{d})}
\]
where (from the output) the sample mean *increase* in beta-endorphin concentration is 7.70 fmol/mol, and the *standard error for this increase* is 3.10 fmol/mol.
From the null hypothesis (which we assume to be true), $\mu_d = 0$.
Hence:

\[
   t = \frac{7.70 - 0}{3.10} = 2.48,
\]
which is quite large.
Using the 68--95-99.7 rule, we would expect a small **one-tailed** $P$-value (and certainly less than 0.025).
jamovi reports a two-tailed $P$-value of 0.023, so a one-tailed $P$-value of $0.023/2 = 0.0115$.
We conclude (where the CI was [found earlier](#StressSurgery)):

> Strong evidence exists in the sample (paired $t = 2.48$; one-tailed $P = 0.0115$) of a population mean increase in beta-endorphin concentrations from 12--14 hours before surgery to 10 minutes before surgery (95% CI: 1.62 to 13.78 fmol/mol.)

The sample size is $n = 19$, just less than 25, so the results may not be statistically valid (but shouldn't be too bad).

:::



<!-- QUICK REVIEW ANSWERS -->
`r if (knitr::is_html_output()) '<!--'`
::: {.QRanswerBox .QRanswer data-latex="{iconmonstr-check-mark-14-240.png}"}
\textbf{Answers to \textit{Quick Revision} questions:}
**1.** False.
**2.** True.
**3.** 2.23.
**4.** Very small.
:::
`r if (knitr::is_html_output()) '-->'`


